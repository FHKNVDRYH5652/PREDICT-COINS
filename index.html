
<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Baba Tillu Pro — Deep Analyzer (Updated)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#06060a; --bg2:#071426; --card:rgba(255,255,255,0.03);
    --accent1:#ff416c; --accent2:#ffd200; --muted:#9fb0d6;
  }
  *{box-sizing:border-box;font-family:'Poppins',sans-serif}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#eaf6ff;display:flex;align-items:flex-start;justify-content:center;padding:28px}
  .container{width:100%;max-width:1100px}
  header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .logo{width:64px;height:64px;border-radius:12px;overflow:hidden;background:#0b0b0f;border:2px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  h1{font-size:20px;margin:0; background:linear-gradient(90deg,var(--accent1),var(--accent2)); -webkit-background-clip:text;color:transparent}
  .subtitle{color:var(--muted);font-size:13px}
  main{display:grid;grid-template-columns:360px 1fr;gap:18px}
  @media(max-width:980px){main{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 14px 50px rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.02)}
  .small{color:var(--muted);font-size:13px}
  .plans .plan{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
  .btn{background:linear-gradient(90deg,#00d2a8,#00a6ff);color:#012;padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:800}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px;border-radius:8px}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;margin-top:8px}
  label{font-size:13px;color:var(--muted);display:block;margin-top:10px}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  .admin-cross{position:fixed;right:18px;bottom:18px;width:46px;height:46px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;cursor:pointer;z-index:999}
  .row{display:flex;gap:8px;align-items:center}
  .prediction-grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
  .box{padding:12px;border-radius:10px;background:rgba(255,255,255,0.015);border:1px solid rgba(255,255,255,0.03)}
  .results-list{max-height:230px;overflow:auto;padding:8px;border-radius:8px;background:rgba(0,0,0,0.18)}
  .result-pill{display:inline-block;padding:6px 8px;border-radius:999px;margin:6px 6px 0 0;font-weight:700}
  .result-pill.B{background:linear-gradient(90deg,#0c5,#06d);color:#003}
  .result-pill.S{background:linear-gradient(90deg,#ffb66b,#ff7a7a);color:#300}
  .reason{font-size:13px;color:var(--muted);margin-top:8px;white-space:pre-line}
  .stat{font-weight:800}
  .progress{height:12px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden;margin-top:8px}
  .progress > div{height:100%;background:linear-gradient(90deg,#00d2a8,#00a6ff);width:0}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo"><img src="anime1.png" alt="logo" style="width:100%;height:100%;object-fit:cover"></div>
    <div>
      <h1>Baba Tillu Pro</h1>
      <div class="subtitle">Deep-analysis predictions — safer multi-level staking</div>
    </div>
  </header>

  <main>
    <!-- LEFT: plans/payment/admin -->
    <div class="card">
      <div id="view-plans">
        <h3>Choose Plan</h3>
        <div class="small">Pick plan and pay deposit. After admin approval you get access to prediction panel.</div>
        <div id="plansContainer" style="margin-top:12px"></div>
      </div>

      <div id="view-payment" style="display:none">
        <h3>Payment — Submit UTR</h3>
        <div class="small">Scan QR → Pay deposit shown → Enter 12-digit UTR → Submit for admin approval.</div>
        <label>Plan</label><div id="selectedPlanBox" class="box"></div>
        <label>Scan QR</label>
        <div id="qrBox" class="box" style="height:200px;display:flex;align-items:center;justify-content:center"></div>
        <label>Enter 12-digit UTR</label>
        <input id="inputUtr" maxlength="12" placeholder="Enter 12-digit UTR">
        <label>Upload screenshot (optional)</label>
        <input id="fileInput" type="file" accept="image/*">
        <img id="previewImg" style="max-width:100%;display:none;margin-top:8px;border-radius:8px" />
        <div class="row" style="margin-top:12px">
          <button class="btn" id="submitPaymentBtn">Submit for approval</button>
          <button class="btn-ghost" id="backBtn">Back</button>
        </div>
        <div id="paymentStatus" class="small" style="margin-top:10px"></div>
      </div>

      <div id="view-admin" style="display:none;margin-top:12px">
        <h3>Admin — Approvals</h3>
        <div class="small">Pending payments below. Approve to grant access.</div>
        <div id="pendingList" style="margin-top:10px"></div>
        <div style="margin-top:10px"><button class="btn-ghost" id="refreshPending">Refresh</button></div>
      </div>
    </div>

    <!-- RIGHT: prediction -->
    <div class="card" id="predictionCard" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div class="stat">Prediction Panel</div><div class="small">Deep heuristic analyzer — requires last 10 rounds</div></div>
        <div>
          <div class="small">Active Plan</div>
          <div id="activePlanLabel" class="stat">—</div>
        </div>
      </div>

      <div style="margin-top:12px" class="prediction-grid">
        <div>
          <label>Enter starting period (e.g. 20250914100011151)</label>
          <input id="periodInput" placeholder="Enter period number">
          <div class="row" style="margin-top:10px">
            <button class="btn" id="generateBtn" disabled>Generate Prediction</button>
            <button class="btn-ghost" id="autoGenToggle">Auto-next: OFF</button>
          </div>

          <div style="margin-top:12px" class="box">
            <div>Prediction: <span id="predictionText" style="font-weight:900">--</span></div>
            <div style="margin-top:8px">Confidence: <span id="confidenceText">--</span></div>
            <div style="margin-top:8px">Suggested Bet: <span id="betText">--</span></div>
            <div style="margin-top:8px">Balance: ₹<span id="balanceText">0</span></div>
            <div style="margin-top:8px">Level: <span id="levelText">1</span></div>
            <div class="progress"><div id="progressBar" style="width:0%"></div></div>
            <div id="reasonBox" class="reason"></div>
          </div>

          <div style="margin-top:12px">
            <div class="small">Enter last results (B or S) — minimum 10 required. The system uses these to compute prediction.</div>
            <div id="last10container" class="results-list" style="margin-top:8px"></div>
            <div class="row" style="margin-top:8px">
              <input id="manualResultInput" placeholder="B or S" style="width:120px">
              <button class="btn-ghost" id="addResultBtn">Add</button>
              <button class="btn-ghost" id="clearResultsBtn">Clear</button>
            </div>
          </div>

          <div style="margin-top:12px" class="row">
            <button class="btn" id="markWin">Mark Win</button>
            <button class="btn-ghost" id="markLoss">Mark Loss</button>
          </div>
        </div>

        <div>
          <div class="box">
            <div style="font-weight:800">History (latest 10)</div>
            <div id="recentBox" class="results-list" style="margin-top:10px"></div>
          </div>

          <div style="margin-top:12px" class="box">
            <div style="font-weight:800">Analysis snapshot</div>
            <div id="analysisBox" class="reason"></div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <footer>Made for you — assets: anime1.png, anime2.png, anime3.png, qr.png</footer>
</div>

<div class="admin-cross" id="adminCross">❌</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ===================
   Firebase config (yours)
   =================== */
const firebaseConfig = {
  apiKey: "AIzaSyBs7eQyMrcN8kJWMHl2ac2UZHlYQ6DypD8",
  authDomain: "terminal-xxrr.firebaseapp.com",
  databaseURL: "https://terminal-xxrr-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "terminal-xxrr",
  storageBucket: "terminal-xxrr.firebasestorage.app",
  messagingSenderId: "722753278120",
  appId: "1:722753278120:web:bfa37aab39635a4e57f29d",
  measurementId: "G-E3MZH3E1K5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ======= App state ======= */
const plans = [
  {id:'p1',label:'100 → 300',deposit:100,price:50},
  {id:'p2',label:'200 → 1000',deposit:200,price:90},
  {id:'p3',label:'500 → 5000',deposit:500,price:220},
  {id:'p4',label:'1000 → 15000',deposit:1000,price:400},
  {id:'p5',label:'2000 → 30000',deposit:2000,price:800}
];

let selectedPlan = null;
let currentPaymentKey = null;
let currentUserId = null;
let balance = 0;
let level = 1;
let lastResults = loadLastResults() || []; // latest-first array of 'B' or 'S'
let autoNext = false;
let currentPrediction = null;

/* ======= DOM ======= */
const plansContainer = document.getElementById('plansContainer');
const viewPlans = document.getElementById('view-plans');
const viewPayment = document.getElementById('view-payment');
const viewAdmin = document.getElementById('view-admin');

const selectedPlanBox = document.getElementById('selectedPlanBox');
const qrBox = document.getElementById('qrBox');
const inputUtr = document.getElementById('inputUtr');
const fileInput = document.getElementById('fileInput');
const previewImg = document.getElementById('previewImg');
const submitPaymentBtn = document.getElementById('submitPaymentBtn');
const backBtn = document.getElementById('backBtn');
const paymentStatus = document.getElementById('paymentStatus');
const adminCross = document.getElementById('adminCross');
const pendingList = document.getElementById('pendingList');
const refreshPending = document.getElementById('refreshPending');

const predictionCard = document.getElementById('predictionCard');
const activePlanLabel = document.getElementById('activePlanLabel');
const periodInput = document.getElementById('periodInput');
const generateBtn = document.getElementById('generateBtn');
const autoGenToggle = document.getElementById('autoGenToggle');
const predictionText = document.getElementById('predictionText');
const confidenceText = document.getElementById('confidenceText');
const betText = document.getElementById('betText');
const balanceText = document.getElementById('balanceText');
const levelText = document.getElementById('levelText');
const reasonBox = document.getElementById('reasonBox');
const progressBar = document.getElementById('progressBar');

const last10container = document.getElementById('last10container');
const manualResultInput = document.getElementById('manualResultInput');
const addResultBtn = document.getElementById('addResultBtn');
const clearResultsBtn = document.getElementById('clearResultsBtn');

const markWinBtn = document.getElementById('markWin');
const markLossBtn = document.getElementById('markLoss');

const recentBox = document.getElementById('recentBox');
const analysisBox = document.getElementById('analysisBox');

/* ======= Render Plans ======= */
function renderPlans(){
  plansContainer.innerHTML = '';
  plans.forEach(p=>{
    const d = document.createElement('div');
    d.className = 'plan';
    d.innerHTML = `<div>
      <div style="font-weight:800">${p.label}</div>
      <div class="small">Deposit ₹${p.deposit} • Price ₹${p.price}</div>
    </div>
    <div><button class="btn-ghost choose" data-id="${p.id}">Choose</button></div>`;
    plansContainer.appendChild(d);
  });
  document.querySelectorAll('.choose').forEach(b=>{
    b.addEventListener('click', ()=> choosePlan(b.getAttribute('data-id')));
  });
}
renderPlans();

/* ======= Choose Plan -> Payment ======= */
function choosePlan(id){
  selectedPlan = plans.find(x=>x.id===id);
  if(!selectedPlan) return;
  viewPlans.style.display = 'none';
  viewPayment.style.display = 'block';
  selectedPlanBox.innerText = `${selectedPlan.label} — deposit ₹${selectedPlan.deposit}`;
  // Create UPI QR (demo)
  const upi = `upi://pay?pa=yourupi@bank&pn=BabaTillu&am=${encodeURIComponent(selectedPlan.deposit)}&cu=INR`;
  const qr = 'https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=' + encodeURIComponent(upi);
  qrBox.innerHTML = `<img src="qr.png" style="max-width:100%;border-radius:8px">`;
  previewImg.style.display = 'none';
  paymentStatus.innerText = '';
  inputUtr.value = '';
  fileInput.value = '';
}
backBtn.addEventListener('click', ()=>{ viewPayment.style.display='none'; viewPlans.style.display='block'; });

fileInput.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) { previewImg.style.display='none'; return; }
  const r = new FileReader();
  r.onload = ()=>{ previewImg.src = r.result; previewImg.style.display='block'; };
  r.readAsDataURL(f);
});

/* ======= Submit Payment -> Firebase ======= */
submitPaymentBtn.addEventListener('click', async ()=>{
  const utr = (inputUtr.value||'').trim();
  if(!/^\d{12}$/.test(utr)){ paymentStatus.innerText = 'Enter valid 12-digit UTR'; return; }
  submitPaymentBtn.disabled = true;
  paymentStatus.innerText = 'Submitting...';
  let imageBase = null;
  if(fileInput.files && fileInput.files[0]){
    imageBase = await fileToBase64(fileInput.files[0]);
  }
  const uid = 'u_' + Date.now() + '_' + Math.floor(Math.random()*9000+1000);
  currentUserId = uid;
  const payload = {
    uid, planId: selectedPlan.id, planLabel: selectedPlan.label,
    deposit: selectedPlan.deposit, utr, image: imageBase || null,
    status: 'pending', createdAt: Date.now()
  };
  const newRef = db.ref('payments').push();
  await newRef.set(payload);
  currentPaymentKey = newRef.key;
  paymentStatus.innerText = 'Submitted. Waiting for admin approval...';
  submitPaymentBtn.disabled = false;

  // listen for approval
  db.ref('payments/' + currentPaymentKey + '/status').on('value', snap=>{
    const val = snap.val();
    if(val === 'approved'){
      db.ref('payments/' + currentPaymentKey).once('value').then(snap2=>{
        onPaymentApproved(snap2.val());
      });
    } else if(val === 'rejected'){
      paymentStatus.innerText = 'Payment rejected by admin.';
    }
  });
});
function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* ======= Admin (hidden cross) ======= */
const ADMIN_PASS = '456';
adminCross.addEventListener('click', ()=>{
  const pw = prompt('Enter admin password:');
  if(!pw) return;
  if(pw === ADMIN_PASS){
    viewPlans.style.display = 'none';
    viewPayment.style.display = 'none';
    viewAdmin.style.display = 'block';
    renderPending();
  } else alert('Wrong password');
});

function renderPending(){
  pendingList.innerText = 'Loading...';
  db.ref('payments').orderByChild('status').equalTo('pending').once('value', snap=>{
    const v = snap.val() || {};
    pendingList.innerHTML = '';
    const keys = Object.keys(v).reverse();
    if(!keys.length){ pendingList.innerHTML = '<div class="small">No pending requests</div>'; return; }
    keys.forEach(k=>{
      const p = v[k];
      const div = document.createElement('div');
      div.className = 'box';
      div.style.marginBottom='10px';
      div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><b>${p.planLabel}</b><div class="small">UTR: ${p.utr} • ${new Date(p.createdAt).toLocaleString()}</div></div>
        <div style="text-align:right">
          <button class="btn" data-key="${k}">Approve</button><br><button class="btn-ghost" data-rej="${k}" style="margin-top:8px">Reject</button>
        </div>
      </div>
      <div style="margin-top:8px">${p.image ? '<img src="'+p.image+'" style="max-width:100%;border-radius:8px">' : '<div class="small">No image</div>'}</div>`;
      pendingList.appendChild(div);
    });
    pendingList.querySelectorAll('button[data-key]').forEach(b=> b.addEventListener('click', ()=> approvePayment(b.getAttribute('data-key'))));
    pendingList.querySelectorAll('button[data-rej]').forEach(b=> b.addEventListener('click', ()=> rejectPayment(b.getAttribute('data-rej'))));
  });
}
refreshPending.addEventListener('click', renderPending);
async function approvePayment(key){
  await db.ref('payments/' + key).update({status:'approved', approvedAt: Date.now(), approvedBy: 'admin'});
  alert('Approved');
  renderPending();
}
async function rejectPayment(key){
  if(!confirm('Reject?')) return;
  await db.ref('payments/' + key).update({status:'rejected', rejectedAt: Date.now()});
  alert('Rejected');
  renderPending();
}

/* ======= When payment approved (for the user) ======= */
function onPaymentApproved(data){
  // open prediction UI and set balance
  balance = data.deposit || selectedPlan?.deposit || 0;
  level = 1;
  activePlanLabel.innerText = data.planLabel || selectedPlan?.label || '—';
  balanceText.innerText = balance;
  levelText.innerText = level;
  // show prediction panel
  viewPlans.style.display = 'none';
  viewPayment.style.display = 'none';
  viewAdmin.style.display = 'none';
  predictionCard.style.display = 'block';
  updateLast10UI();
  loadRecentHistoryUI();
  enableGenerateIfReady();
}

/* ======= Last-results UI & storage ======= */
function loadLastResults(){
  try{ return JSON.parse(localStorage.getItem('bt_last_results')||'[]'); }catch(e){ return []; }
}
function saveLastResults(){ try{ localStorage.setItem('bt_last_results', JSON.stringify(lastResults)); }catch(e){} }
function updateLast10UI(){
  last10container.innerHTML = '';
  if(!lastResults.length){
    last10container.innerHTML = '<div class="small">No results yet. Please enter at least 10 (most recent first).</div>';
  } else {
    lastResults.slice(0,50).forEach((r, i)=>{
      const span = document.createElement('span');
      span.className = 'result-pill ' + r;
      span.innerText = r;
      // allow click to remove a specific item
      span.title = 'Click to remove this entry';
      span.style.cursor = 'pointer';
      span.addEventListener('click', ()=>{ if(confirm('Remove this entry?')){ lastResults.splice(i,1); saveLastResults(); updateLast10UI(); enableGenerateIfReady(); } });
      last10container.appendChild(span);
    });
  }
  enableGenerateIfReady();
}

/* add manual result */
addResultBtn.addEventListener('click', ()=>{
  const v = (manualResultInput.value||'').trim().toUpperCase();
  if(v !== 'B' && v !== 'S'){ alert('Enter B or S'); return; }
  lastResults.unshift(v);
  lastResults = lastResults.slice(0, 200);
  manualResultInput.value = '';
  saveLastResults();
  updateLast10UI();
  loadRecentHistoryUI();
});

/* clear results */
clearResultsBtn.addEventListener('click', ()=>{
  if(!confirm('Clear all saved last results?')) return;
  lastResults = [];
  saveLastResults();
  updateLast10UI();
});

/* ======= generate button enable only after >=10 last results ======= */
function enableGenerateIfReady(){
  if(lastResults.length >= 10) generateBtn.disabled = false;
  else { generateBtn.disabled = true; predictionText.innerText='--'; confidenceText.innerText='--'; betText.innerText='--'; reasonBox.innerText='Enter at least 10 last results.'; progressBar.style.width='0%'; }
}
enableGenerateIfReady();

/* ======= Analysis engine (deep heuristic) ======= */
function analyzeDeep(results){
  // require at least 10 by caller
  const N = Math.min(results.length, 50);
  const arr = results.slice(0, N); // latest-first
  // Weighted recent frequency (exponential decay)
  let wSum = 0, wB = 0, wS = 0;
  const decay = 0.88; // more weight to recent
  for(let i=0;i<arr.length;i++){
    const w = Math.pow(decay, i);
    wSum += w;
    if(arr[i] === 'B') wB += w; else wS += w;
  }
  const freqB_w = wB / wSum;
  const freqS_w = wS / wSum;

  // simple frequency (unweighted)
  const freqB = arr.filter(x=>x==='B').length / N;
  const freqS = 1 - freqB;

  // streak analysis: compute last streak length & which side
  let lastSide = arr[0];
  let streak = 1;
  for(let i=1;i<arr.length;i++){ if(arr[i] === lastSide) streak++; else break; }

  // alternating measure
  let alt=0;
  for(let i=1;i<arr.length;i++) if(arr[i] !== arr[i-1]) alt++;
  const altFrac = alt / (arr.length - 1 || 1);

  // transition (Markov order-1): P(next|last)
  const last = arr[0];
  let countAfterLast = 0, countAfterLastB = 0;
  for(let i=0;i<arr.length-1;i++){
    if(arr[i] === last){
      countAfterLast++;
      if(arr[i+1] === 'B') countAfterLastB++;
    }
  }
  const pB_given_last = countAfterLast ? (countAfterLastB / countAfterLast) : 0.5;
  const pS_given_last = 1 - pB_given_last;

  // pattern frequency (hot/cold)
  // contrarian: people bet majority -> minority tends to appear; implement as boost to minority
  const majority = freqB > freqS ? 'B' : 'S';
  const majPct = Math.max(freqB, freqS);

  // compute scores
  // base: mean reversion (1 - freq weighted)
  let scoreB = (1 - freqB_w) * 0.6 + (pB_given_last) * 0.25 + (altFrac * 0.15);
  let scoreS = (1 - freqS_w) * 0.6 + (pS_given_last) * 0.25 + (altFrac * 0.15);

  // streak-breaker: if long streak on one side, favor break
  if(lastSide === 'B' && streak >= 3) scoreS += 0.18;
  if(lastSide === 'S' && streak >= 3) scoreB += 0.18;

  // contrarian boost: favor minority side moderately
  if(majority === 'B') scoreS += (majPct - 0.5) * 0.5;
  else scoreB += (majPct - 0.5) * 0.5;

  // normalize and compute probabilities
  const sum = scoreB + scoreS || 1;
  let pB = scoreB / sum;
  let pS = scoreS / sum;

  // confidence calculation
  const baseConf = Math.min(0.9, 0.6 + Math.abs(pB - pS) * 1.2 + Math.min(N,30)/30*0.15);
  let chosen = pB > pS ? 'B' : 'S';
  let confidence = Math.max(0.35, baseConf);

  // final safety adjustments:
  // if low confidence (<0.6), reduce suggested bet later (handled in caller)
  // If lastLossConsecutive >=1 and level >=2, attempt contrarian strong shift
  const recentLoss = countRecentConsecutiveLosses();

  const reasonLines = [
    `Samples considered: ${N}`,
    `Weighted freq — B:${(freqB_w*100).toFixed(1)}% S:${(freqS_w*100).toFixed(1)}%`,
    `Raw freq — B:${(freqB*100).toFixed(1)}% S:${(freqS*100).toFixed(1)}%`,
    `Last streak: ${streak} on ${lastSide}`,
    `Alternation: ${(altFrac*100).toFixed(1)}%`,
    `P(next=B|last=${last}): ${(pB_given_last*100).toFixed(1)}%`,
    `Heuristics: mean-reversion + markov + streak-breaker + contrarian`
  ];

  return {pB, pS, chosen, confidence, reason: reasonLines.join('\n')};
}

/* ======= generatePrediction (requires >=10 lastResults) ======= */
generateBtn.addEventListener('click', ()=>{
  if(lastResults.length < 10){ alert('Please enter at least 10 last results (most recent first).'); return; }
  const period = (periodInput.value||'').trim();
  if(!/^\d+$/.test(period)){ alert('Enter a valid period number'); return; }

  const analysis = analyzeDeep(lastResults);
  let choice = analysis.chosen;
  let conf = analysis.confidence;
  let pmax = Math.max(analysis.pB, analysis.pS);

  // Beast-mode / safety logic: if there was a recent loss, be conservative and prefer opposite of last actual if analysis supports
  const recentLosses = countRecentConsecutiveLosses();
  if(recentLosses >= 1){
    const lastActual = lastResults[0];
    const opposite = lastActual === 'B' ? 'S' : 'B';
    // If analysis gives at least moderate support for opposite, pick it and boost confidence slightly
    if((opposite === 'B' && analysis.pB > 0.52) || (opposite === 'S' && analysis.pS > 0.52)){
      choice = opposite;
      pmax = opposite === 'B' ? analysis.pB : analysis.pS;
      conf = Math.max(conf, Math.min(0.92, 0.6 + (pmax - 0.5)));
    } else {
      // otherwise pick the highest but keep confidence as-is
      choice = analysis.pB > analysis.pS ? 'B' : 'S';
      pmax = Math.max(analysis.pB, analysis.pS);
    }
  }

  // if low pmax (<0.6) and level ===1, reduce bet suggestion (lower risk)
  const suggestedBase = calcBetAmount(balance, level);
  let suggestedBet = suggestedBase;
  if(pmax < 0.6 && level === 1){
    suggestedBet = Math.max(1, Math.round(suggestedBase * 0.5)); // reduce risk
  } else if (pmax >= 0.7 && level >= 2){
    suggestedBet = suggestedBase; // allow full bet
  } else if (pmax >= 0.8){
    suggestedBet = Math.round(suggestedBase * 1.0);
  } else {
    suggestedBet = Math.round(suggestedBase * 0.8);
  }

  // store currentPrediction
  currentPrediction = {
    period, choice, confidence: Math.round(conf*100), pmax,
    suggestedBet, generatedAt: Date.now()
  };

  // Update UI
  predictionText.innerText = choice === 'B' ? 'BIG' : 'SMALL';
  confidenceText.innerText = Math.round(conf*100) + '%';
  betText.innerText = '₹' + suggestedBet;
  progressBar.style.width = Math.round(conf*100) + '%';
  reasonBox.innerText = analysis.reason;

  // record that a prediction was generated (for session)
  // No automatic change to lastResults — it will be updated when user marks win/loss
});

/* ======= Bet-level calc (15/30/55) ======= */
function calcBetAmount(balanceLocal, levelLocal){
  const a1 = Math.max(1, Math.round(balanceLocal * 0.15));
  const a2 = Math.max(1, Math.round(balanceLocal * 0.30));
  const a3 = Math.max(1, Math.round(balanceLocal * 0.55));
  if(levelLocal === 1) return a1;
  if(levelLocal === 2) return a2;
  return a3;
}

/* ======= mark result (win/loss) handling ======= */
markWinBtn.addEventListener('click', ()=> {
  if(!currentPrediction) { alert('Generate a prediction first'); return; }
  finalizeResult('win');
});
markLossBtn.addEventListener('click', ()=> {
  if(!currentPrediction) { alert('Generate a prediction first'); return; }
  finalizeResult('loss');
});

function finalizeResult(result){
  const pred = currentPrediction;
  if(!pred) return;
  const bet = pred.suggestedBet || calcBetAmount(balance, level);
  // determine actual outcome to append to lastResults:
  const actual = (result === 'win') ? pred.choice : (pred.choice === 'B' ? 'S' : 'B');

  // update lastResults
  lastResults.unshift(actual);
  lastResults = lastResults.slice(0, 200);
  saveLastResults();
  updateLast10UI();

  // update balance & level
  if(result === 'win'){
    balance = Math.round(balance + bet);
    level = 1; // reset
  } else {
    balance = Math.max(0, balance - bet);
    if(level < 3) level++;
    else level = 1; // after heavy loss reset or you can keep at 3
  }
  balanceText.innerText = balance;
  levelText.innerText = level;

  // add to persistent results history
  const hist = JSON.parse(localStorage.getItem('bt_results')||'[]');
  hist.unshift({period: pred.period, signal: pred.choice, result, bet, ts: Date.now()});
  localStorage.setItem('bt_results', JSON.stringify(hist.slice(0, 500)));
  loadRecentHistoryUI();

  // clear currentPrediction
  currentPrediction = null;
  predictionText.innerText = '--';
  confidenceText.innerText = '--';
  betText.innerText = '--';
  progressBar.style.width = '0%';
  reasonBox.innerText = '';

  // auto-increment period if autoNext enabled
  if(autoNext){
    try {
      const next = incrementPeriodString(pred.period);
      periodInput.value = next;
    } catch(e){}
  }
}

/* ======= utilities ======= */
function countRecentConsecutiveLosses(){
  const arr = JSON.parse(localStorage.getItem('bt_results')||'[]');
  let cnt = 0;
  for(let i=0;i<arr.length;i++){
    if(arr[i].result === 'loss') cnt++; else break;
  }
  return cnt;
}
function incrementPeriodString(s){
  // Use BigInt to increment numeric period string
  try{
    const n = BigInt(s);
    return (n + BigInt(1)).toString();
  }catch(e){
    // fallback: numeric add with parseInt (may overflow)
    return (parseInt(s,10)+1).toString();
  }
}
function loadRecentHistoryUI(){
  const arr = JSON.parse(localStorage.getItem('bt_results')||'[]').slice(0,10);
  recentBox.innerHTML = '';
  if(!arr.length){ recentBox.innerHTML = '<div class="small">No history yet.</div>'; return; }
  arr.forEach(r=>{
    const d = document.createElement('div');
    d.className = 'result-item';
    d.style.padding='8px'; d.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    d.innerHTML = `<div style="font-weight:700">${r.period}</div>
      <div class="small">${r.signal} • ${r.result} • ₹${r.bet}</div>
      <div class="small">${new Date(r.ts).toLocaleTimeString()}</div>`;
    recentBox.appendChild(d);
  });
  // show short analysis summary
  const hist = JSON.parse(localStorage.getItem('bt_results')||'[]');
  const wins = hist.filter(x=>x.result==='win').length;
  const losses = hist.filter(x=>x.result==='loss').length;
  analysisBox.innerText = `History count: ${hist.length}\nWins: ${wins} • Losses: ${losses}\nCurrent balance: ₹${balance}`;
}

/* ======= Auto-next toggle ======= */
autoGenToggle.addEventListener('click', ()=>{
  autoNext = !autoNext;
  autoGenToggle.innerText = 'Auto-next: ' + (autoNext ? 'ON' : 'OFF');
});

/* ======= Init ======= */
(function init(){
  // initial UI
  viewPlans.style.display='block';
  viewPayment.style.display='none';
  viewAdmin.style.display='none';
  predictionCard.style.display='none';
  balanceText.innerText = 0;
  levelText.innerText = 1;
  updateLast10UI();
  loadRecentHistoryUI();
  enableGenerateIfReady();
  // listen for approvals to user's payment key (if page was open)
  // live updates handled on submitPayment
})();

</script>
</body>
</html>
