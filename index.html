<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Baba Tillu Pro — Prediction Portal (Firebase & Admin)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#04060a; --card:#0b1116; --muted:#9fb0d6; --accent:#00d2a8;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box;font-family:'Poppins',system-ui,Arial,sans-serif}
body{margin:0;background:linear-gradient(180deg,#020306,#071022);color:#eaf6ff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.app{width:100%;max-width:1100px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:0 30px 80px rgba(0,0,0,0.6)}
.header{display:flex;align-items:center;gap:14px}
.logo{width:64px;height:64px;border-radius:8px;overflow:hidden;background:#111;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.04)}
.logo img{width:100%;height:100%;object-fit:cover}
.title{font-weight:700;font-size:20px;color:var(--accent)}
.subtitle{color:#bcd6ea;font-size:13px}
.main{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:16px}
@media(max-width:980px){.main{grid-template-columns:1fr}}
.card{background:var(--card);padding:14px;border-radius:10px;min-height:220px}
.plans{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.plan{padding:12px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03)}
.plan b{display:block}
.btn{padding:10px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),#00a6ff);color:#001;font-weight:800;cursor:pointer}
.link{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:#9fb0d6;cursor:pointer}
.small{color:#9fb0d6;font-size:13px}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;margin-top:8px}
.row{display:flex;gap:8px;align-items:center}
.admin-cross{position:fixed;right:14px;bottom:14px;width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;cursor:pointer;z-index:9999;opacity:0.7}
.admin-cross:hover{opacity:1;transform:scale(1.02)}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999;visibility:hidden;opacity:0;transition:all .18s}
.modal.show{visibility:visible;opacity:1}
.modal-card{background:#071122;padding:16px;border-radius:10px;min-width:320px}
.prediction-box{display:flex;flex-direction:column;gap:8px}
.box{display:inline-block;padding:8px 10px;border-radius:8px;background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.04);min-width:90px;text-align:center;font-weight:700}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.results-list{max-height:220px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03)}
.footer{margin-top:12px;color:#9fb0d6;font-size:13px;text-align:center}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo"><img id="logoImg" src="anime1.png" alt="logo"></div>
    <div>
      <div class="title">Baba Tillu Pro</div>
      <div class="subtitle">Advanced predictions — simple flow</div>
    </div>
  </div>

  <div class="main">
    <!-- LEFT: plans -> payment -> prediction -->
    <div class="card">
      <h3>Select Plan</h3>
      <div class="small">Choose a plan — payment via QR + UTR. Admin approval required to unlock predictions.</div>

      <div class="plans" id="plansContainer" style="margin-top:12px"></div>

      <hr style="margin:12px 0;border:0;border-top:1px solid rgba(255,255,255,0.03)">

      <div id="paymentSection" style="display:none">
        <h4>Payment — Scan & Submit UTR</h4>
        <div class="small">Scan QR, pay the exact amount shown and then enter 12-digit UTR below.</div>
        <img id="qrImg" src="" alt="QR" style="width:200px;height:200px;display:block;margin-top:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
        <input id="utrInput" class="input" placeholder="Enter 12-digit UTR" maxlength="12">
        <div style="margin-top:8px" class="row">
          <button class="btn" id="submitPaymentBtn">Submit for Approval</button>
          <button class="link" id="cancelPaymentBtn">Cancel</button>
        </div>
        <div id="paymentStatus" class="small" style="margin-top:8px"></div>
      </div>

      <div id="predictionSection" style="display:none;margin-top:14px">
        <h3>Prediction</h3>
        <div class="small">Enter last 10 results (Big/Small) once, then click GENERATE. AI analyses trend, frequency & psychology to recommend a side and bet amount.</div>

        <div style="margin-top:8px">
          <label class="small">Your Balance (plan-based):</label>
          <div style="font-weight:800;font-size:1.1rem" id="balanceDisplay">₹0</div>
        </div>

        <div style="margin-top:8px">
          <label class="small">Last 10 rounds (enter B or S, left->oldest, right->latest):</label>
          <div class="row" style="margin-top:8px">
            <input id="historyInput" class="input" placeholder="e.g. B,B,S,B,B,S,B,B,S,B" />
            <button class="btn" id="applyHistoryBtn">Apply</button>
          </div>
        </div>

        <div style="margin-top:10px" class="prediction-box">
          <div>PERIOD: <span id="periodDisplay" class="box">--</span></div>
          <div>SUGGESTION: <span id="suggestionBox" class="box">--</span></div>
          <div>CONFIDENCE: <span id="confidenceBox" class="box">--</span></div>
          <div>BET AMOUNT: <span id="betBox" class="box">--</span></div>
          <div style="margin-top:8px" class="controls">
            <button class="btn" id="generateBtn">Generate Prediction</button>
            <button class="link" id="skipBtn">Skip (if unclear)</button>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <button class="btn" id="markWinBtn">Win</button>
            <button class="link" id="markLossBtn">Loss</button>
            <div style="margin-left:auto;text-align:right">
              <div id="statsText" class="small">Wins: 0 • Losses: 0 • Accuracy: 0%</div>
              <div id="lastCount" class="small">(Last 0)</div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700;margin-bottom:6px">Recent results (latest first)</div>
          <div id="resultsList" class="results-list"></div>
        </div>
      </div>

    </div>

    <!-- RIGHT: admin + info -->
    <div class="card">
      <h3>Admin & Info</h3>
      <div class="small">Admin panel is hidden (❌). Click the bottom-right cross to open (admin key required).</div>

      <div style="margin-top:12px">
        <div class="small" style="font-weight:700">Server status:</div>
        <div id="serverStatus" class="small" style="margin-top:6px">Not connected</div>
      </div>

      <div style="margin-top:12px">
        <div class="small" style="font-weight:700">Pending payments</div>
        <div id="pendingList" class="results-list" style="margin-top:8px;min-height:120px">No pending</div>
      </div>

      <div style="margin-top:12px">
        <div class="small" style="font-weight:700">Admin actions</div>
        <div style="margin-top:8px" id="adminControlsArea">
          <div class="small">(Hidden until admin unlock)</div>
        </div>
      </div>
    </div>

  </div>

  <div class="footer">Background images: anime1.png, anime2.png, anime3.png — change assets in the same folder.</div>
</div>

<!-- hidden admin cross -->
<div class="admin-cross" id="adminCross">❌</div>

<!-- modal -->
<div id="modal" class="modal"><div class="modal-card">
  <div id="modalTitle" style="font-weight:800;color:var(--accent)"></div>
  <div id="modalSub" class="small" style="margin-top:8px"></div>
  <div style="margin-top:12px"><button class="btn" id="modalOkBtn">OK</button></div>
</div></div>

<!-- Firebase + app script -->
<script type="module">
  // Firebase modular SDK imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  // -- replace with your firebase config (already provided) --
  const firebaseConfig = {
    apiKey: "AIzaSyBs7eQyMrcN8kJWMHl2ac2UZHlYQ6DypD8",
    authDomain: "terminal-xxrr.firebaseapp.com",
    databaseURL: "https://terminal-xxrr-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "terminal-xxrr",
    storageBucket: "terminal-xxrr.firebasestorage.app",
    messagingSenderId: "722753278120",
    appId: "1:722753278120:web:bfa37aab39635a4e57f29d",
    measurementId: "G-E3MZH3E1K5"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Plans definition
  const PLANS = [
    { id: 'p1', label: '100 → 300', min:100, max:300, price:40 },
    { id: 'p2', label: '200 → 1000', min:200, max:1000, price:150 },
    { id: 'p3', label: '500 → 5000', min:500, max:5000, price:400 },
    { id: 'p4', label: '1000 → 15000', min:1000, max:15000, price:900 },
    { id: 'p5', label: '2000 → 30000', min:2000, max:30000, price:1700 },
    // premium
    { id: 'p6', label: '1000 → 50000 (Premium)', min:1000, max:50000, price:2500 },
    { id: 'p7', label: '2000 → 100000 (Premium)', min:2000, max:100000, price:4500 },
    { id: 'p8', label: '5000 → 500000 (Premium)', min:5000, max:500000, price:12000 }
  ];

  // UI refs
  const plansContainer = document.getElementById('plansContainer');
  const paymentSection = document.getElementById('paymentSection');
  const predictionSection = document.getElementById('predictionSection');
  const qrImg = document.getElementById('qrImg');
  const utrInput = document.getElementById('utrInput');
  const submitPaymentBtn = document.getElementById('submitPaymentBtn');
  const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
  const paymentStatus = document.getElementById('paymentStatus');
  const balanceDisplay = document.getElementById('balanceDisplay');
  const applyHistoryBtn = document.getElementById('applyHistoryBtn');
  const historyInput = document.getElementById('historyInput');
  const generateBtn = document.getElementById('generateBtn');
  const suggestionBox = document.getElementById('suggestionBox');
  const confidenceBox = document.getElementById('confidenceBox');
  const betBox = document.getElementById('betBox');
  const periodDisplay = document.getElementById('periodDisplay');
  const resultsList = document.getElementById('resultsList');
  const statsText = document.getElementById('statsText');
  const lastCount = document.getElementById('lastCount');
  const markWinBtn = document.getElementById('markWinBtn');
  const markLossBtn = document.getElementById('markLossBtn');
  const serverStatus = document.getElementById('serverStatus');
  const pendingList = document.getElementById('pendingList');

  // state
  let selectedPlan = null;
  let pendingPaymentId = null;
  let activeUnlocked = false;
  let balance = 0;
  let level = 1; // 1 -> 15% , 2 -> 30% , 3 -> 55%
  let lastResults = []; // latest-first
  let historyArr = []; // persisted results
  let wins = 0, losses = 0;

  // render plans
  function renderPlans(){
    plansContainer.innerHTML = '';
    PLANS.forEach(p=>{
      const div = document.createElement('div');
      div.className = 'plan';
      div.innerHTML = `<b>${p.label}</b>
        <div class="small">Price: ₹${p.price}</div>
        <div style="margin-top:8px">Target range: <span class="small">₹${p.min} → ₹${p.max}</span></div>
        <div style="margin-top:10px"><button class="btn" data-id="${p.id}" data-price="${p.price}">Choose</button></div>`;
      plansContainer.appendChild(div);
    });
    // attach listeners
    [...plansContainer.querySelectorAll('button')].forEach(b=>{
      b.addEventListener('click', ()=> {
        const id = b.dataset.id;
        const plan = PLANS.find(x=>x.id===id);
        openPaymentForPlan(plan);
      });
    });
  }

  function openPaymentForPlan(plan){
    selectedPlan = plan;
    paymentSection.style.display = 'block';
    predictionSection.style.display = 'none';
    paymentStatus.innerText = '';
    const upi = `upi://pay?pa=yourupi@bank&pn=BabaTillu&am=${encodeURIComponent(plan.price)}&cu=INR`;
    qrImg.src = 'https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=' + encodeURIComponent(upi);
    paymentSection.scrollIntoView({behavior:'smooth'});
  }

  cancelPaymentBtn.addEventListener('click', ()=>{
    paymentSection.style.display = 'none';
    utrInput.value = '';
    paymentStatus.innerText = '';
  });

  // submit payment -> write to firebase realtime db under /payments
  submitPaymentBtn.addEventListener('click', async ()=>{
    const utr = (utrInput.value||'').trim();
    if(!selectedPlan){ alert('Select a plan first'); return; }
    if(!/^[0-9]{12}$/.test(utr)){ paymentStatus.innerText='Enter valid 12-digit UTR'; return; }
    submitPaymentBtn.disabled = true;
    paymentStatus.innerText = 'Submitting...';
    try{
      const paymentsRef = ref(db, 'payments');
      const newRef = push(paymentsRef);
      const payload = {
        planId: selectedPlan.id,
        planLabel: selectedPlan.label,
        price: selectedPlan.price,
        utr,
        status: 'pending',
        createdAt: Date.now()
      };
      await set(newRef, payload);
      pendingPaymentId = newRef.key;
      paymentStatus.innerText = 'Submitted — awaiting admin approval';
      const thisRef = ref(db, 'payments/' + pendingPaymentId);
      onValue(thisRef, (snap)=>{
        const data = snap.val();
        if(!data) return;
        if(data.status === 'approved'){
          paymentStatus.innerText = 'Approved — unlocking...';
          unlockUserWithPlan(data);
        } else if(data.status === 'rejected'){
          paymentStatus.innerText = 'Rejected by admin';
        }
      });
    }catch(err){
      console.error(err);
      paymentStatus.innerText = 'Error: ' + (err.message||err);
    } finally { submitPaymentBtn.disabled = false; }
  });

  function unlockUserWithPlan(data){
    balance = selectedPlan ? selectedPlan.min : 100;
    balanceDisplay.innerText = '₹' + balance;
    level = 1;
    activeUnlocked = true;
    predictionSection.style.display = 'block';
    paymentSection.style.display = 'none';
    historyArr = [];
    renderHistoryUI();
  }

  // ADMIN: hidden cross opens prompt for password
  const adminCross = document.getElementById('adminCross');
  adminCross.addEventListener('click', async ()=>{
    const pw = prompt('Enter admin key:');
    if(pw === null) return;
    if(pw === '456'){
      showModal('Admin unlocked','You can approve/reject payments from the right panel.');
      setupAdminPanel();
    } else {
      alert('Wrong admin key');
    }
  });

  // admin panel: listen to /payments pending and render
  function setupAdminPanel(){
    serverStatus.innerText = 'Connected (Firebase)';
    const paymentsRef = ref(db, 'payments');
    onValue(paymentsRef, (snap)=>{
      const val = snap.val() || {};
      const entries = Object.entries(val).filter(([k,v])=>v.status === 'pending');
      if(entries.length === 0){
        pendingList.innerHTML = '<div class="small">No pending payments</div>';
      } else {
        pendingList.innerHTML = '';
        entries.reverse().forEach(([key, payment])=>{
          const div = document.createElement('div');
          div.style.padding='8px';
          div.style.borderBottom='1px solid rgba(255,255,255,0.03)';
          div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">${payment.planLabel} — ₹${payment.price}</div>
              <div class="small">UTR: ${payment.utr} • ${new Date(payment.createdAt).toLocaleString()}</div>
            </div>
            <div style="text-align:right">
              <button class="btn" data-id="${key}" data-act="approve">Approve</button>
              <button class="link" data-id="${key}" data-act="reject">Reject</button>
            </div>
          </div>`;
          pendingList.appendChild(div);
        });
        [...pendingList.querySelectorAll('button')].forEach(b=>{
          b.onclick = async ()=> {
            const id = b.dataset.id;
            const act = b.dataset.act;
            if(act === 'approve'){
              await update(ref(db, 'payments/' + id), { status: 'approved', approvedAt: Date.now() });
            } else {
              await update(ref(db, 'payments/' + id), { status: 'rejected', approvedAt: Date.now() });
            }
          };
        });
      }
    });
  }

  // Prediction: apply user-entered history
  applyHistoryBtn.addEventListener('click', ()=>{
    const txt = (historyInput.value || '').trim();
    if(!txt){ showModal('No input','Enter last 10 results separated by comma (B or S).'); return; }
    const parts = txt.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean).slice(-10);
    lastResults = parts.map(p => (p.startsWith('B')? 'BIG' : 'SMALL'));
    lastResults = lastResults.reverse();
    showModal('History applied','Last rounds stored for analysis.');
  });

  // generate prediction (heuristic AI)
  generateBtn.addEventListener('click', ()=>{
    if(!activeUnlocked){ showModal('Locked','Complete payment & admin approval to unlock predictions.'); return; }
    if(lastResults.length < 3){ showModal('Insufficient history','Enter at least 3 last results (10 recommended).'); return; }
    const period = generateAutoPeriod();
    periodDisplay.innerText = period;
    const resultCounts = lastResults.reduce((acc, r)=>{
      acc[r] = (acc[r] || 0) + 1; return acc;
    }, {});
    const bigCount = resultCounts['BIG'] || 0;
    const smallCount = resultCounts['SMALL'] || 0;
    const total = bigCount + smallCount;
    const bigProb = Math.round((bigCount/total)*100);
    const smallProb = Math.round((smallCount/total)*100);
    const last5 = lastResults.slice(0,5).reverse();
    const trend = last5.filter(x=>x==='BIG').length > last5.filter(x=>x==='SMALL').length ? 'BIG' : (last5.filter(x=>x==='SMALL').length > last5.filter(x=>x==='BIG').length ? 'SMALL' : 'NEUTRAL');
    const alternation = detectAlternation(lastResults);
    const longRun = detectLongRun(lastResults);
    let baseConfidence = Math.max(bigProb, smallProb);
    if(trend !== 'NEUTRAL' && trend === (bigProb>smallProb ? 'BIG' : 'SMALL')) baseConfidence += 10;
    if(alternation) baseConfidence -= 15;
    if(longRun) baseConfidence -= 10;
    baseConfidence = Math.max(10, Math.min(95, baseConfidence));
    let suggestion = 'SKIP';
    if(baseConfidence >= 80){
      suggestion = bigProb > smallProb ? 'BIG' : 'SMALL';
    } else {
      suggestion = 'SKIP';
    }
    const betAmount = computeBetAmount(balance, level);
    suggestionBox.innerText = suggestion;
    confidenceBox.innerText = baseConfidence + '%';
    betBox.innerText = '₹' + betAmount;
  });

  function computeBetAmount(balanceVal, lvl){
    if(lvl === 1) return Math.max(1, Math.round(balanceVal * 0.15));
    if(lvl === 2) return Math.max(1, Math.round(balanceVal * 0.30));
    if(lvl === 3) return Math.max(1, Math.round(balanceVal * 0.55));
    return Math.max(1, Math.round(balanceVal * 0.15));
  }

  function detectAlternation(arr){
    const seq = arr.slice(0,6);
    if(seq.length < 4) return false;
    let alt = true;
    for(let i=2;i<seq.length;i++){
      if(seq[i] === seq[i-2]) { alt = false; break; }
    }
    return alt;
  }
  function detectLongRun(arr){
    if(arr.length < 4) return false;
    const last4 = arr.slice(0,4);
    return last4.every(x=>x===last4[0]);
  }

  function generateAutoPeriod(){
    const now = new Date();
    const YYYY = now.getFullYear().toString().padStart(4,'0');
    const MM = (now.getMonth()+1).toString().padStart(2,'0');
    const DD = now.getDate().toString().padStart(2,'0');
    const hh = now.getHours().toString().padStart(2,'0');
    const mm = now.getMinutes().toString().padStart(2,'0');
    const counter = String(now.getSeconds()).padStart(2,'0') + String(Math.floor(Math.random()*90)+10);
    return `${YYYY}${MM}${DD}${hh}${mm}${counter}`;
  }

  markWinBtn.addEventListener('click', ()=> markResult('win'));
  markLossBtn.addEventListener('click', ()=> markResult('loss'));
  function markResult(type){
    const period = periodDisplay.innerText;
    const suggestion = suggestionBox.innerText;
    if(!period || period === '--'){ showModal('No prediction','Generate a prediction first'); return; }
    const signal = suggestion === 'SKIP' ? 'SKIP' : suggestion;
    const ts = Date.now();
    const res = { period, signal, result: type.toUpperCase(), ts };
    historyArr.unshift(res);
    historyArr = historyArr.slice(0,50);
    localStorage.setItem('bt_history', JSON.stringify(historyArr));
    if(type === 'win') wins++; else losses++;
    const total = wins + losses;
    const acc = total ? Math.round((wins/total)*100) : 0;
    statsText.innerText = `Wins: ${wins} • Losses: ${losses} • Accuracy: ${acc}%`;
    lastCount.innerText = `(Last ${Math.min(historyArr.length,10)})`;
    const bet = computeBetAmount(balance, level);
    if(type === 'win'){
      balance = balance + bet;
      level = 1;
    } else {
      balance = Math.max(0, balance - bet);
      level = Math.min(3, level + 1);
    }
    balanceDisplay.innerText = '₹' + balance;
    renderHistoryUI();
  }

  function renderHistoryUI(){
    resultsList.innerHTML = '';
    const arr = historyArr.slice(0,10);
    arr.forEach(r=>{
      const d = document.createElement('div');
      d.style.padding='8px'; d.style.borderBottom='1px solid rgba(255,255,255,0.03)';
      d.innerHTML = `<div style="display:flex;justify-content:space-between">
        <div><strong>${r.period}</strong><div class="small">${r.signal} • ${r.result}</div></div>
        <div class="small">${new Date(r.ts).toLocaleTimeString()}</div>
      </div>`;
      resultsList.appendChild(d);
    });
  }

  // modal util
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalSub = document.getElementById('modalSub');
  const modalOkBtn = document.getElementById('modalOkBtn');
  function showModal(title, sub=''){ modalTitle.innerText = title; modalSub.innerText = sub; modal.classList.add('show'); }
  function closeModal(){ modal.classList.remove('show'); }
  modalOkBtn.addEventListener('click', closeModal);

  // init
  renderPlans();
  serverStatus.innerText = 'Connected (Firebase ready)';
  (function loadLocal(){
    try{
      const h = JSON.parse(localStorage.getItem('bt_history')||'[]');
      historyArr = Array.isArray(h) ? h : [];
      wins = historyArr.filter(x=>x.result==='WIN').length;
      losses = historyArr.filter(x=>x.result==='LOSS').length;
      renderHistoryUI();
    }catch(e){}
  })();

</script>
</body>
</html>
