<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Loss Recovery (Firebase)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#071022; --card:#0f1724; --muted:#9fb0d6; --accent:#ff6b6b; --accent2:#ffd166;
}
*{box-sizing:border-box;font-family:'Poppins',sans-serif}
body{margin:0;background:linear-gradient(180deg,#061021,#07142a);color:#eaf6ff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
.app{width:100%;max-width:980px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(0,0,0,0.6);position:relative;overflow:hidden}
.background{position:absolute;inset:0;opacity:0.06;background-image:url('anime.png');background-size:cover;background-position:center;filter:blur(2px)}
.header{display:flex;align-items:center;gap:12px}
.logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#071022}
.title{font-size:18px;font-weight:800}
.subtitle{color:var(--muted);font-size:13px}
.container{margin-top:18px}
.card{background:transparent;padding:18px;border-radius:10px}
.center{display:flex;flex-direction:column;align-items:center;gap:12px;text-align:center}
.bigbtn{padding:12px 18px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#071022;font-weight:800;cursor:pointer}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:10px 12px;border-radius:8px;cursor:pointer}
.input{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit;width:220px;text-align:center}
.row{display:flex;gap:8px;align-items:center;justify-content:center}
.plans{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
.plan{padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));cursor:pointer;min-width:140px}
.plan.selected{box-shadow:0 10px 30px rgba(0,0,0,0.5);transform:translateY(-6px)}
.small{font-size:13px;color:var(--muted)}
.qr{width:260px;height:260px;border-radius:12px;border:4px solid rgba(255,255,255,0.03);object-fit:cover}
.hidden{display:none}
.footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}
.admin-cross{position:fixed;right:18px;bottom:18px;width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;cursor:pointer;z-index:999}
.panel{position:fixed;right:18px;top:18px;width:420px;background:rgba(10,10,12,0.95);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);z-index:999;box-shadow:0 12px 40px rgba(0,0,0,0.6);color:#dfe}
.list{max-height:360px;overflow:auto;margin-top:8px}
.item{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center;gap:8px}
.badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);font-weight:700}
.step{border-radius:8px;padding:14px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);margin-top:12px}
.success{color:#b4f8c8}
.warn{color:#ffd6a5}
.note{font-size:13px;color:#b9d3ff}
</style>
</head>
<body>
<div class="app" role="application">
  <div class="background" aria-hidden="true"></div>

  <div class="header">
    <div class="logo">LR</div>
    <div>
      <div class="title">Loss Recovery</div>
      <div class="subtitle">Smart recovery — Firebase powered</div>
    </div>
  </div>

  <div class="container">
    <!-- Pages -->
    <div id="page-welcome" class="card center">
      <h2>Welcome to Loss Recovery</h2>
      <p class="small">Apka swagat hai — hum aapki madad karenge aapka loss recover karne mein.</p>
      <button class="bigbtn" id="welcomeNext">Next</button>
      <div class="small">(Voice guidance enabled)</div>
    </div>

    <div id="page-amount" class="card center hidden">
      <h3>How much is your loss?</h3>
      <input id="lossAmount" class="input" type="number" placeholder="Enter amount in Rs" min="1"/>
      <div class="row" style="margin-top:10px">
        <button class="bigbtn" id="confirmAmount">Confirm</button>
        <button class="ghost" id="amountBack">Back</button>
      </div>
      <div class="small">Amount dala jaayega aur voice se confirm hogi</div>
    </div>

    <div id="page-plans" class="card center hidden">
      <h3>Choose recovery plan</h3>
      <div class="small">Plans ke price loss amount ke % par based honge</div>
      <div class="plans" id="plansBox"></div>
      <div class="row" style="margin-top:12px">
        <button class="bigbtn" id="choosePlanBtn">Proceed to Payment</button>
        <button class="ghost" id="plansBack">Back</button>
      </div>
    </div>

    <div id="page-payment" class="card center hidden">
      <h3>Payment</h3>
      <div class="small">Scan QR and pay exact amount for the chosen plan. Then enter 12-digit UTR and confirm.</div>
      <img src="qr.png" alt="QR" class="qr" id="qrImg" onerror="this.src='';" />
      <div style="margin-top:10px"><input id="utrInput" class="input" placeholder="Enter 12-digit UTR" maxlength="12"></div>
      <div class="row" style="margin-top:10px">
        <button class="bigbtn" id="submitPayment">Submit UTR & Request Approval</button>
        <button class="ghost" id="paymentBack">Back</button>
      </div>
      <div style="margin-top:10px" class="small">If approval delayed, contact: <a href="https://t.me/Nskskssiwi" target="_blank" style="color:#bfe">Customer Service</a></div>
      <div id="paymentStatus" class="small" style="margin-top:8px"></div>
    </div>

    <div id="page-strategy" class="card hidden">
      <h3>Recovery Strategy</h3>
      <div id="strategyIntro" class="small">Preparing your step-by-step recovery plan...</div>
      <div id="strategySteps" class="step hidden"></div>
      <div class="row" style="margin-top:12px">
        <button class="bigbtn" id="strategyNext" disabled>Next Step</button>
        <button class="ghost" id="strategyFinish" style="display:none">Finish</button>
      </div>
      <div id="strategyNote" class="small" style="margin-top:10px"></div>
    </div>

    <div class="footer">Demo: Firebase Realtime DB approvals enabled. Keep QR and anime.png in same folder.</div>
  </div>

  <div class="admin-cross" id="adminCross" title="Admin">❌</div>

  <div id="adminPanel" class="panel hidden" role="dialog" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Admin Panel</div>
      <div class="small">Locked</div>
    </div>

    <div style="margin-top:8px">
      <input id="adminPass" class="input" placeholder="Enter admin password" type="password"/>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="bigbtn" id="adminLoginBtn">Login</button>
        <button class="ghost" id="adminCloseBtn">Close</button>
      </div>
    </div>

    <div id="adminControls" class="hidden">
      <div style="margin-top:12px;font-weight:700">Pending Payments</div>
      <div class="list" id="pendingList"></div>
      <div style="margin-top:8px" class="small">Approve will notify the user (Realtime DB).</div>
    </div>
  </div>

</div>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
/* ====== CONFIG - INSERT YOUR FIREBASE CONFIG ======
   You gave this earlier; I include it here.
   If you change config, update below.
*/
const firebaseConfig = {
  apiKey: "AIzaSyBs7eQyMrcN8kJWMHl2ac2UZHlYQ6DypD8",
  authDomain: "terminal-xxrr.firebaseapp.com",
  databaseURL: "https://terminal-xxrr-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "terminal-xxrr",
  storageBucket: "terminal-xxrr.firebasestorage.app",
  messagingSenderId: "722753278120",
  appId: "1:722753278120:web:bfa37aab39635a4e57f29d",
  measurementId: "G-E3MZH3E1K5"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* SPA state & pages */
const pages = {
  welcome: document.getElementById('page-welcome'),
  amount: document.getElementById('page-amount'),
  plans: document.getElementById('page-plans'),
  payment: document.getElementById('page-payment'),
  strategy: document.getElementById('page-strategy')
};
let state = { lossAmount:0, chosenPlan:null, chosenPlanPrice:0, chosenPlanKey:null, pendingUTR:null };

/* show page + voice */
function showPage(name){
  Object.values(pages).forEach(p=>p.classList.add('hidden'));
  pages[name].classList.remove('hidden');
  if(name==='welcome') speakHindi('स्वागत है Loss Recovery में। आगे बढ़ने के लिए नेक्स्ट दबाएं।');
  if(name==='amount') speakHindi('कितना नुकसान हुआ है ? कृपया राशि दर्ज करें और कन्फर्म करें।');
  if(name==='plans') speakHindi('अपना प्लान चुनें। आपकी राशि के अनुसार प्राइस दिखाई देगा।');
  if(name==='payment') speakHindi('क्यूआर से भुगतान करें और 12 अंकों का U T R डालकर सबमिट करें।');
  if(name==='strategy') speakHindi('आपकी रिकवरी रणनीति तैयार हो रही है, कृपया आगे बढ़ें।');
}
function speakHindi(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang='hi-IN'; u.rate=0.95; u.pitch=0.95;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }catch(e){}
}

/* init */
document.getElementById('welcomeNext').addEventListener('click', ()=> showPage('amount'));
document.getElementById('amountBack').addEventListener('click', ()=> showPage('welcome'));
document.getElementById('plansBack').addEventListener('click', ()=> showPage('amount'));
document.getElementById('paymentBack').addEventListener('click', ()=> showPage('plans'));

document.getElementById('confirmAmount').addEventListener('click', ()=>{
  const v = Number(document.getElementById('lossAmount').value);
  if(!v || v<=0){ alert('कृपया वैध राशि दर्ज करें'); return; }
  state.lossAmount = Math.round(v);
  speakHindi(`आपका नुकसान ${state.lossAmount} रूपये रिकॉर्ड हो गया है। अब प्लान चुनें।`);
  setTimeout(renderPlans, 800);
});

/* Plans */
const plansDef = [
  {key:'3m', label:'3 Months', pct:7},
  {key:'1m', label:'1 Month', pct:12.5},
  {key:'1w', label:'1 Week', pct:15},
  {key:'3d', label:'3 Days', pct:20},
  {key:'1d', label:'1 Day', pct:25}
];

function renderPlans(){
  const box = document.getElementById('plansBox');
  box.innerHTML = '';
  plansDef.forEach(p=>{
    const price = Math.max(1, Math.round(state.lossAmount * (p.pct/100) * 100)/100);
    const div = document.createElement('div');
    div.className = 'plan';
    div.id = 'plan-' + p.key;
    div.innerHTML = `<div style="font-weight:800">${p.label}</div>
      <div class="small">${p.pct}% of loss</div>
      <div style="margin-top:8px;font-weight:700">₹ ${price.toFixed(2)}</div>`;
    div.addEventListener('click', ()=> {
      document.querySelectorAll('.plan').forEach(x=>x.classList.remove('selected'));
      div.classList.add('selected');
      state.chosenPlan = p;
      state.chosenPlanPrice = Number(price.toFixed(2));
      state.chosenPlanKey = p.key;
      speakHindi(`${p.label} चुना गया। आगे भुगतान करें।`);
    });
    box.appendChild(div);
  });
  showPage('plans');
}

document.getElementById('choosePlanBtn').addEventListener('click', ()=>{
  if(!state.chosenPlan){ alert('कृपया प्लान चुनें'); return; }
  document.getElementById('paymentStatus').innerText = '';
  document.getElementById('utrInput').value = '';
  document.getElementById('qrImg').src = 'qr.png';
  showPage('payment');
  speakHindi(`आपने ${state.chosenPlan.label} चुना। भुगतान राशि ${state.chosenPlanPrice} रुपये है।`);
});

/* Payment -> write pending to Firebase */
document.getElementById('submitPayment').addEventListener('click', async ()=>{
  const utr = document.getElementById('utrInput').value.trim();
  if(!/^[0-9]{12}$/.test(utr)){ alert('कृपया 12 अंकों का UTR दर्ज करें'); return; }
  const payload = {
    utr, amount: state.chosenPlanPrice, plan: state.chosenPlanKey, loss: state.lossAmount, ts: Date.now()
  };
  try{
    // write to /pending/<utr>
    await db.ref('pending/' + utr).set(payload);
    state.pendingUTR = utr;
    document.getElementById('paymentStatus').innerText = 'Payment submitted — awaiting admin approval.';
    speakHindi('आपका अनुरोध भेज दिया गया है। एडमिन के अप्रूवल का इंतज़ार करें।');
    listenForApproval(utr);
  }catch(e){
    alert('Firebase error: ' + e.message);
  }
});

/* Listen for approval on /approved/<utr> */
function listenForApproval(utr){
  const apprRef = db.ref('approved/' + utr);
  apprRef.on('value', snap=>{
    if(snap.exists()){
      // approved
      document.getElementById('paymentStatus').innerText = '✅ Approved by admin. Preparing strategy...';
      speakHindi('आपका भुगतान अप्रूव हो गया है। अब हम आपकी रिकवरी योजना तैयार करेंगे।');
      setTimeout(()=> {
        createStrategy(state.lossAmount, state.chosenPlanKey);
        showPage('strategy');
      }, 1000);
    }
  });
}

/* Admin panel behavior */
const adminCross = document.getElementById('adminCross');
const adminPanel = document.getElementById('adminPanel');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const adminPass = document.getElementById('adminPass');
const adminCloseBtn = document.getElementById('adminCloseBtn');
const adminControls = document.getElementById('adminControls');
const pendingList = document.getElementById('pendingList');

adminCross.addEventListener('click', ()=> adminPanel.classList.toggle('hidden'));
adminCloseBtn.addEventListener('click', ()=> adminPanel.classList.add('hidden'));

adminLoginBtn.addEventListener('click', async ()=>{
  const p = adminPass.value || '';
  if(p !== '456'){ alert('Incorrect password'); return; }
  adminControls.classList.remove('hidden');
  adminPass.value = '';
  // start listening pending node
  loadPendingFirebase();
});

/* load pending payments from Firebase and render */
let pendingRef = null;
function loadPendingFirebase(){
  if(pendingRef) pendingRef.off();
  pendingRef = db.ref('pending');
  pendingRef.on('value', snap=>{
    pendingList.innerHTML = '';
    const data = snap.val() || {};
    const keys = Object.keys(data).sort((a,b)=> (data[b].ts||0)-(data[a].ts||0));
    if(keys.length===0){ pendingList.innerHTML = '<div class="small">No pending payments</div>'; return; }
    keys.forEach(k=>{
      const p = data[k];
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div style="flex:1">
          <div style="font-weight:800">${p.utr} • ₹${p.amount}</div>
          <div class="note">loss ₹${p.loss} • plan ${p.plan} • ${new Date(p.ts).toLocaleString()}</div>
        </div>`;
      const btns = document.createElement('div');
      btns.style.display='flex'; btns.style.gap='8px';
      const approve = document.createElement('button'); approve.className='bigbtn'; approve.textContent='Approve';
      approve.addEventListener('click', async ()=>{
        try{
          await db.ref('approved/' + p.utr).set({by:'admin',ts:Date.now(),payload:p});
          await db.ref('pending/' + p.utr).remove();
          alert('Approved ' + p.utr);
        }catch(e){ alert('Error: '+e.message); }
      });
      const reject = document.createElement('button'); reject.className='ghost'; reject.textContent='Reject';
      reject.addEventListener('click', async ()=>{
        if(!confirm('Reject payment ' + p.utr + '?')) return;
        try{
          await db.ref('pending/' + p.utr).remove();
          alert('Rejected ' + p.utr);
        }catch(e){ alert('Error: '+e.message); }
      });
      btns.appendChild(approve); btns.appendChild(reject);
      div.appendChild(btns);
      pendingList.appendChild(div);
    });
  });
}

/* Strategy creation (as before) */
const strategyStepsEl = document.getElementById('strategySteps');
const strategyNextBtn = document.getElementById('strategyNext');
const strategyFinishBtn = document.getElementById('strategyFinish');
const strategyIntro = document.getElementById('strategyIntro');
const strategyNote = document.getElementById('strategyNote');

let currentStepIndex = 0;
let generatedSteps = [];

function createStrategy(lossAmnt, planKey){
  generatedSteps = [];
  currentStepIndex = 0;
  const planMap = {
    '3m': {label:'3 Months', days:90, feePct:7},
    '1m': {label:'1 Month', days:30, feePct:12.5},
    '1w': {label:'1 Week', days:7, feePct:15},
    '3d': {label:'3 Days', days:3, feePct:20},
    '1d': {label:'1 Day', days:1, feePct:25}
  };
  const plan = planMap[planKey] || planMap['1m'];
  const fee = Math.round((lossAmnt * (plan.feePct/100))*100)/100;

  generatedSteps.push({title:`Plan: ${plan.label}`, text:`आपने ${plan.label} चुना है। प्लान की फीस ₹${fee} है।`});
  const deposit = Math.max(1, Math.round(lossAmnt * 0.05 * 100)/100);
  generatedSteps.push({title:'Step 1: Initial Deposit', text:`आरम्भ के लिए ₹${deposit} जमा करें (5% of loss).`});
  generatedSteps.push({title:'Step 2: Open WINGO 1-min', text:'WINGO 1-min खोलें और हमारे सुझावों का पालन करें।'});
  const days = plan.days;
  const dailyTarget = Math.max(1, Math.round((lossAmnt / days) * 100)/100);
  generatedSteps.push({title:'Step 3: Daily Target', text:`हर दिन लक्ष्य: ₹${dailyTarget}`});
  generatedSteps.push({title:'Step 4: Bet sizing', text:'Levels: Level1=15%, Level2=30%, Level3=55%. Loss पर level up करें।'});
  generatedSteps.push({title:'Step 5: Safety rules', text:'यदि दो बार लगातार loss आते हैं, strategy बदलें और छोटे bets लें।'});
  generatedSteps.push({title:'Final: Completion', text:'Target पूरा होने पर Complete दबाएँ।'});

  renderStrategy();
  speakHindi('Strategy तैयार है। पहले स्टेप के लिए नेक्स्ट दबाएँ।');
}

function renderStrategy(){
  strategyStepsEl.innerHTML = '';
  generatedSteps.forEach((s, idx)=>{
    const d = document.createElement('div');
    d.className = 'step';
    d.id = 'step-' + idx;
    d.innerHTML = `<div style="font-weight:800">${s.title}</div><div style="margin-top:6px">${s.text}</div>`;
    if(idx !== currentStepIndex) d.style.display = 'none';
    strategyStepsEl.appendChild(d);
  });
  strategyStepsEl.classList.remove('hidden');
  strategyNextBtn.disabled = false;
  strategyNextBtn.style.display = 'inline-block';
  strategyFinishBtn.style.display = 'none';
  strategyIntro.innerText = `आपके पास ${generatedSteps.length} स्टेप हैं।`;
  speakCurrentStep();
}

function speakCurrentStep(){
  const s = generatedSteps[currentStepIndex];
  if(s) speakHindi(s.text);
}

strategyNextBtn.addEventListener('click', ()=>{
  if(currentStepIndex < generatedSteps.length -1){
    document.getElementById('step-' + currentStepIndex).style.display = 'none';
    currentStepIndex++;
    document.getElementById('step-' + currentStepIndex).style.display = 'block';
    speakCurrentStep();
    if(currentStepIndex === generatedSteps.length -1){
      strategyNextBtn.disabled = true;
      strategyNextBtn.style.display = 'none';
      strategyFinishBtn.style.display = 'inline-block';
      strategyFinishBtn.disabled = false;
      strategyNote.innerText = 'अंतिम स्टेप पर हैं — Finish दबाएँ।';
    } else {
      strategyNote.innerText = `Step ${currentStepIndex+1} of ${generatedSteps.length}`;
    }
  }
});

strategyFinishBtn.addEventListener('click', ()=>{
  speakHindi('बधाई हो! आपकी recovery journey शुरू हो गई है।');
  alert('Recovery plan started. You can start again from welcome.');
  location.reload();
});

/* initial show */
showPage('welcome');
speakHindi('Welcome to Loss Recovery. आपका स्वागत है। आगे बढ़ने के लिए Next दबाएँ।');

</script>
</body>
</html>
