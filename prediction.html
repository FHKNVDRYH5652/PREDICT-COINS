<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Coin Predictions — Prediction</title>
  <style>
    body{background:#07121a;color:#eaf6ff;font-family:Inter,system-ui,Arial;margin:0;padding:20px}
    .wrap{max-width:900px;margin:auto}
    h2{margin:0 0 12px 0}
    .card{background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;margin-bottom:16px}
    .btn{background:linear-gradient(90deg,#00ff9d,#1dd3ff);color:#001;
      padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:center}
    .muted{color:#9fb0d6;font-size:13px}
    .tag{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
    .big{background:#1dd3ff22;color:#1dd3ff}
    .small{background:#00ff9d22;color:#00ff9d}
    .win{background:#00ff9d33;color:#00ff9d}
    .loss{background:#ff4d4d33;color:#ff4d4d}
  </style>
</head>
<body>
<div class="wrap">
  <h2>Prediction Panel</h2>
  <div class="card">
    <div>Wallet: <strong id="wallet">0</strong> coins</div>
    <div style="margin-top:10px">
      <button id="genBtn" class="btn">Generate Prediction (10 coins)</button>
    </div>
    <div id="lastPrediction" style="margin-top:10px" class="muted"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Prediction History</h3>
    <div class="muted">Win / Loss mark करने से accuracy calculate होगी</div>
    <table>
      <thead>
        <tr>
          <th>Period</th>
          <th>Signal</th>
          <th>Result</th>
          <th>Mark</th>
        </tr>
      </thead>
      <tbody id="history"></tbody>
    </table>
    <div style="margin-top:10px" id="accuracy" class="muted">Accuracy: 0%</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBs7eQyMrcN8kJWMHl2ac2UZHlYQ6DypD8",
    authDomain: "terminal-xxrr.firebaseapp.com",
    databaseURL: "https://terminal-xxrr-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "terminal-xxrr",
    storageBucket: "terminal-xxrr.appspot.com",
    messagingSenderId: "722753278120",
    appId: "1:722753278120:web:bfa37aab39635a4e57f29d"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const walletEl = document.getElementById('wallet');
  const genBtn = document.getElementById('genBtn');
  const lastPrediction = document.getElementById('lastPrediction');
  const historyEl = document.getElementById('history');
  const accuracyEl = document.getElementById('accuracy');

  let userId = null;
  let wallet = 0;
  let history = [];

  // Period number sync from Firestore (admin sets base period)
  let basePeriod = "";
  const periodDoc = doc(db,"system","period");
  onSnapshot(periodDoc,snap=>{
    if(snap.exists()){
      basePeriod = snap.data().number;
    }
  });

  // Auth + Wallet sync
  onAuthStateChanged(auth, async user=>{
    if(user){
      userId = user.uid;
      const uDoc = doc(db,'users',userId);
      onSnapshot(uDoc, snap=>{
        if(snap.exists()){
          const data = snap.data();
          wallet = data.wallet || 0;
          walletEl.innerText = wallet;
          history = data.history || [];
          renderHistory();
        }
      });
    }
  });

  // Generate Prediction
  genBtn.onclick = async ()=>{
    if(wallet < 10){ alert("Not enough coins!"); return; }
    const signal = Math.random() > 0.5 ? "Big" : "Small";
    const period = basePeriod || "----";

    wallet -= 10;
    const pred = { period, signal, result:"", ts:Date.now() };
    history.unshift(pred);

    lastPrediction.innerHTML = `Your Prediction: <span class="tag ${signal.toLowerCase()}">${signal}</span> for Period <b>${period}</b>`;

    await updateDoc(doc(db,'users',userId), {
      wallet,
      history
    });
  };

  // Render History
  function renderHistory(){
    historyEl.innerHTML = "";
    history.forEach((h,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${h.period}</td>
        <td><span class="tag ${h.signal.toLowerCase()}">${h.signal}</span></td>
        <td>${h.result ? `<span class="tag ${h.result}">${h.result}</span>` : '-'}</td>
        <td>
          <button onclick="markResult(${i},'win')">Win</button>
          <button onclick="markResult(${i},'loss')">Loss</button>
        </td>
      `;
      historyEl.appendChild(tr);
    });
    calcAccuracy();
  }

  // Mark Result
  window.markResult = async (idx,res)=>{
    history[idx].result = res;
    await updateDoc(doc(db,'users',userId),{ history });
    renderHistory();
  };

  // Accuracy
  function calcAccuracy(){
    const done = history.filter(h=>h.result);
    const wins = done.filter(h=>h.result==="win").length;
    const acc = done.length ? ((wins/done.length)*100).toFixed(1) : 0;
    accuracyEl.innerText = `Accuracy: ${acc}% (Wins: ${wins}/${done.length})`;
  }
</script>
</body>
</html>
